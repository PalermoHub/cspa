<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Studio Demografico e Socio-Economico del Centro Storico di  Palermo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
	        <link rel="shortcut icon" href="https://palermohub.opendatasicilia.it/favicon.ico"/> 
        <link rel="icon" href="https://palermohub.opendatasicilia.it/favicon.png" type="image/png"/> 
    <!-- Librerie MapLibre -->
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <!-- Libreria PMTiles -->
    <script src="https://unpkg.com/pmtiles@2.4.0/dist/index.js"></script>
    <style>
#ods { position:fixed; bottom:40px; right:20px; z-index: 1500;}
#beta { position:fixed; bottom:90px; right:20px; z-index: 1500;}
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }
        #map { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            width: 100%; 
        }
        
        /* Pannello controlli */
        .control-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255,255,255,0.70);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 230px;
            backdrop-filter: blur(5px);
            max-height: calc(100vh - 20px);
            overflow-y: auto;
        }
        
        .control-section {
            margin-bottom: 20px;
        }
        
        .control-section h3 {
            margin: 0 0 12px 0;
            font-size: 12px;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        
        .basemap-option, .theme-option, .form-control {
            display: block;
            width: 100%;
            margin: 6px 0;
            padding: 10px 15px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            text-align: left;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .basemap-option:hover, .theme-option:hover, .form-control:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .basemap-option.active, .theme-option.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Checkbox personalizzato */
        .checkbox-container {
            display: block;
            position: relative;
            padding-left: 35px;
            margin-bottom: 12px;
            cursor: pointer;
            font-size: 11px;
            user-select: none;
            color: #495057;
        }

        .checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 16px;
            width: 16px;
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .checkbox-container:hover input ~ .checkmark {
            background-color: #e9ecef;
            border-color: #667eea;
        }

        .checkbox-container input:checked ~ .checkmark {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }

        .checkbox-container .checkmark:after {
            left: 6px;
            top: 2px;
            width: 6px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        /* Pannello informazioni */
        .info-panel {
            position: absolute;
            top: 10px;
            right: -380px;
            width: 370px;
            height: calc(100vh - 40px);
            background: rgba(255,255,255,0.98);
            border-radius: 12px 0 0 12px;
            box-shadow: -5px 0 25px rgba(0,0,0,0.15);
            z-index: 1000;
            transition: right 0.4s ease;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        .info-panel.visible {
            right: 10px;
        }
        
        .info-panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 0 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .info-panel-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .close-panel {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-panel:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .info-content {
            padding: 20px;
        }
        
        .info-group {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .info-group h3 {
            margin: 0 0 12px 0;
            color: #2c3e50;
            font-size: 14px;
            font-weight: 600;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 6px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .info-label {
            font-weight: 500;
            color: #34495e;
            flex: 1;
			font-size: 12px;
        }
        
        .info-value {
            color: #2c3e50;
            font-weight: 600;
            text-align: right;
			font-size: 12px;
        }
        
        /* Legenda */
        .legend {
            position: absolute;
            bottom: 10px;
            left: 280px;
            background: rgba(255,255,255,0.70);
            padding: 5px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            min-width: 120px;
            backdrop-filter: blur(5px);
            display: none;
        }
        
        .legend.visible {
            display: block;
        }
        
        .legend h4 {
            margin: 0 0 12px 0;
            font-size: 12px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 15px;
            margin-right: 10px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .legend-label {
            font-size: 12px;
            color: #34495e;
        }
        
        /* Header */
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }
        
        #map {
            top: 60px;
            height: calc(100vh - 60px);
        }
        
        .control-panel {
            top: 70px;
        }
        
        .info-panel {
            top: 80px;
            height: calc(100vh - 100px);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .control-panel {
                width: calc(100vw - 40px);
                max-height: 40vh;
                overflow-y: auto;
            }
            
            .info-panel {
                width: calc(100vw - 20px);
                right: -100vw;
            }
            
            .info-panel.visible {
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèõÔ∏è Studio Demografico e Socio-Economico del Centro Storico di  Palermo</h1>
    </div>

    <div id="map"></div>
    
    <div class="control-panel">
        <div class="control-section">
            <h3>üó∫Ô∏è Mappa Base</h3>
            <select id="basemap-select" class="form-control">
                <option value="carto-light">CartoDB Light</option>
                <option value="satellite">Vista Satellitare</option>
            </select>
        </div>
        
        <div class="control-section">
            <h3>üèõÔ∏è Filtri Mandamenti</h3>
            <select id="mandamento-filter" class="form-control">
                <option value="">Tutti i Mandamenti</option>
            </select>
        </div>
        
        <div class="control-section">
            <h3>üìã Filtri Fogli</h3>
            <select id="foglio-filter" class="form-control">
                <option value="">Tutti i Fogli</option>
            </select>
        </div>
        
        <div class="control-section">
            <h3>üìä Indicatori Demografici</h3>
            <select id="demographic-select" class="form-control">
                <option value="">Seleziona indicatore...</option>
                <option value="population">üë• Popolazione Stimata</option>
                <option value="age">üë¥ Et√† Media</option>
                <option value="elderly">üëµ Tasso Anziani</option>
                <option value="density">üè† Densit√† Abitativa</option>
                <option value="foreign">üåç Popolazione Straniera</option>
            </select>
        </div>
        
        <div class="control-section">
            <h3>üíº Indicatori Socio-Economici</h3>
            <select id="economic-select" class="form-control">
                <option value="">Seleziona indicatore...</option>
                <option value="employment">üíº Tasso Occupazione</option>
                <option value="genderGap">‚öñÔ∏è Divario Genere</option>
                <option value="education">üéì Istruzione Superiore</option>
                <option value="resilience">üí™ Resilienza Economica</option>
                <option value="cohesion">ü§ù Coesione Sociale</option>
            </select>
        </div>
        
        <div class="control-section">
            <h3>üèóÔ∏è Indicatori Territoriali</h3>
            <select id="territorial-select" class="form-control">
                <option value="">Seleziona indicatore...</option>
                <option value="buildings">üè¢ Numero Edifici</option>
                <option value="landuse" selected>üó∫Ô∏è Particelle catastali di base</option>
            </select>
        </div>
        
        <div class="control-section">
            <h3>üó∫Ô∏è Perimetri</h3>
            <label class="checkbox-container">
                <input type="checkbox" id="palermo-perimeter">
                <span class="checkmark"></span>
                Limite Amministrativo Palermo
            </label>
            <label class="checkbox-container">
                <input type="checkbox" id="centro-storico-perimeter" >
                <span class="checkmark"></span>
                Centro Storico
            </label>
            <label class="checkbox-container">
                <input type="checkbox" id="upl-cs-perimeter" checked>
                <span class="checkmark"></span>
                Mandamenti
            </label>
        </div>
        
        <div class="control-section">
            <h3>‚öôÔ∏è Visualizzazione</h3>
            <label class="checkbox-container">
                <input type="checkbox" id="borders-toggle">
                <span class="checkmark"></span>
                Mostra bordi poligoni
            </label>
        </div>
    </div>
    
    <div class="info-panel" id="info-panel">
        <div class="info-panel-header">
            <div>
                <h2 id="panel-title">Dettagli Particella</h2>
                <div id="panel-subtitle" style="font-size: 14px; opacity: 0.9; margin-top: 4px;"></div>
            </div>
            <button class="close-panel" onclick="closeInfoPanel()">&times;</button>
        </div>
        <div class="info-content" id="info-content">
            <p style="text-align: center; color: #7f8c8d; margin-top: 50px;">
                Clicca su una particella per visualizzarne i dettagli
            </p>
        </div>
    </div>
    
    <div class="legend" id="legend">
        <h4 id="legend-title">Legenda</h4>
        <div id="legend-items"></div>
    </div>

    <script>
        // Registra il protocollo PMTiles
        const protocol = new pmtiles.Protocol();
        maplibregl.addProtocol("pmtiles", protocol.tile);
        
        // Configurazione mappa
        const center = [13.3614, 38.1157];
        const zoom = 14;
        const maxBounds = [
            [13.32, 38.09],
            [13.40, 38.14]
        ];

        // Colori uso del suolo dal file QML
        const landUseColors = {
            "servizi": "rgba(250,240,230,0.75)",
            "military": "rgba(85,107,47,0.75)",
            "park": "rgba(124,252,0,0.75)",
            "pedestrian": "rgba(123,123,123,0.75)",
            "protected": "rgba(255,192,192,0.75)",
            "recreation": "rgba(111, 167, 183 , 75%)",
            "religious": "rgba(221,101,251,1.0)",
            "residential": "rgba(255,230,153,0.75)",
            "education": "rgba(226,160,54,0.75)",
            "medical": "rgba(222,37,37,0.75)",
            "transportation": "rgba(192,192,192,0.75)",
            "": "rgba(240,240,240,0.75)"
        };

        const landUseLabels = {
            "servizi": "Servizi",
            "military": "Militare",
            "park": "Verde Pubblico",
            "pedestrian": "Pedonale",
            "protected": "Storico",
            "recreation": "Ricreativo",
            "religious": "Religioso",
            "residential": "Residenziale",
            "education": "Educativo",
            "medical": "Ospedale",
            "transportation": "Trasporti",
            "": "Non Classificato"
        };

        // Inizializza mappa
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'carto-light': {
                        type: 'raster',
                        tiles: ['https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png'],
                        tileSize: 256,
                        attribution: '¬© OpenStreetMap contributors, ¬© CartoDB - Rielaborazione dataset di <a href="https://www.linkedin.com/in/gbvitrano/" title="@gbvitrano" target="_blank">@gbvitrano </a> -  '
                    },
                    'satellite': {
                        type: 'raster',
                        tiles: ['https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}'],
                        tileSize: 256,
                        attribution: '¬© Google - Rielaborazione dataset di <a href="https://www.linkedin.com/in/gbvitrano/" title="@gbvitrano" target="_blank">@gbvitrano </a> -'
                    }
                },
                layers: [
                    {
                        id: 'carto-light-layer',
                        type: 'raster',
                        source: 'carto-light',
                        minzoom: 0,
                        maxzoom: 18
                    },
                    {
                        id: 'satellite-layer',
                        type: 'raster',
                        source: 'satellite',
                        minzoom: 0,
                        maxZoom: 17,
                        layout: { visibility: 'none' }
                    }
                ]
            },
            center: center,
            zoom: zoom,
            maxBounds: maxBounds,
            maxZoom: 17,
            minZoom: 12,
            hash: true,
            pitch: 0,
            dragRotate: false
        });

        // Configurazioni tematizzazioni
        const themes = {
            population: {
                name: 'Popolazione Stimata',
                property: 'popolazione_stimata',
                colors: ['#e3f2fd', '#bbdefb', '#90caf9', '#64b5f6', '#42a5f5', '#2196f3', '#1e88e5', '#1976d2'],
                unit: 'abitanti',
                format: (val) => `${val?.toLocaleString() || 'N/D'} ab.`
            },
            age: {
                name: 'Et√† Media',
                property: 'et√†_media',
                colors: ['#fff3e0', '#ffe0b2', '#ffcc80', '#ffb74d', '#ffa726', '#ff9800', '#fb8c00', '#f57c00'],
                unit: 'anni',
                format: (val) => `${val || 'N/D'} anni`
            },
            elderly: {
                name: 'Tasso Anziani',
                property: 'tasso_anziani',
                colors: ['#f1f8e9', '#dcedc8', '#c5e1a5', '#aed581', '#9ccc65', '#8bc34a', '#7cb342', '#689f38'],
                unit: '%',
                format: (val) => `${val || 'N/D'}%`
            },
            density: {
                name: 'Densit√† Abitativa',
                property: 'densit√† abitativa',
                colors: ['#fce4ec', '#f8bbd9', '#f48fb1', '#f06292', '#ec407a', '#e91e63', '#d81b60', '#c2185b'],
                unit: 'ab/km¬≤',
                format: (val) => `${val?.toLocaleString() || 'N/D'} ab/km¬≤`
            },
            foreign: {
                name: 'Popolazione Straniera',
                property: 'tasso_di_popolazione_straniera',
                colors: ['#e0f2f1', '#b2dfdb', '#80cbc4', '#4db6ac', '#26a69a', '#009688', '#00897b', '#00695c'],
                unit: '%',
                format: (val) => `${val || 'N/D'}%`
            },
            employment: {
                name: 'Tasso Occupazione',
                property: 'tasso_di_occupazione',
                colors: ['#f3e5f5', '#e1bee7', '#ce93d8', '#ba68c8', '#ab47bc', '#9c27b0', '#8e24aa', '#7b1fa2'],
                unit: '%',
                format: (val) => `${val || 'N/D'}%`
            },
            genderGap: {
                name: 'Divario Genere Occupazione',
                property: 'divario di genere nell\'occupazione',
                colors: ['#fce4e4', '#f5c6c6', '#eea5a5', '#e78383', '#e06262', '#d84141', '#d12020', '#ca0000'],
                unit: '%',
                format: (val) => `${val || 'N/D'}%`
            },
            education: {
                name: 'Istruzione Superiore',
                property: 'tasso di istruzione superiore',
                colors: ['#e8f5e8', '#c8e6c8', '#a5d6a5', '#82c782', '#5fb85f', '#3ca83c', '#2e7d32', '#1b5e20'],
                unit: '%',
                format: (val) => `${val || 'N/D'}%`
            },
            resilience: {
                name: 'Resilienza Economica',
                property: 'indice_di_resilienza_economica',
                colors: ['#fff8e1', '#ffecb3', '#ffe082', '#ffd54f', '#ffca28', '#ffc107', '#ffb300', '#ffa000'],
                unit: 'indice',
                format: (val) => `${val || 'N/D'}`
            },
            cohesion: {
                name: 'Coesione Sociale',
                property: 'indice_coesione_sociale',
                colors: ['#e1f5fe', '#b3e5fc', '#81d4fa', '#4fc3f7', '#29b6f6', '#03a9f4', '#039be5', '#0288d1'],
                unit: 'indice',
                format: (val) => `${val || 'N/D'}`
            },
            buildings: {
                name: 'Numero Edifici',
                property: 'buildings_count',
                colors: ['#efebe9', '#d7ccc8', '#bcaaa4', '#a1887f', '#8d6e63', '#795548', '#6d4c41', '#5d4037'],
                unit: 'edifici',
                format: (val) => `${val || 'N/D'} edifici`
            }
        };

        let currentTheme = 'landuse';
        let hoveredPolygon = null;
        let currentMandamentoFilter = null;
        let currentFoglioFilter = null;
        let featuresData = []; // Stored per calcoli dinamici
        let availableFogli = []; // Array per memorizzare i fogli disponibili
        let availableMandamenti = ['Castellammare', 'Tribunali', 'Palazzo Reale', 'Monte di Piet√†']; // Mandamenti base
        let allFeatures = []; // Cache di tutte le features per performance

        // Caricamento mappa
        map.on('load', function() {
            // Aggiungi sorgente PMTiles
            map.addSource('palermo_catastale', {
                type: 'vector',
                url: 'pmtiles://https://palermohub.github.io/cspa/dati/pacs.pmtiles'
            });
            
            // Layer base - uso del suolo
            map.addLayer({
                id: 'catastale-base',
                type: 'fill',
                source: 'palermo_catastale',
                'source-layer': 'catastale',
                paint: {
                    'fill-color': [
                        'match',
                        ['get', 'class'],
                        'servizi', landUseColors.servizi,
                        'military', landUseColors.military,
                        'park', landUseColors.park,
                        'pedestrian', landUseColors.pedestrian,
                        'protected', landUseColors.protected,
                        'recreation', landUseColors.recreation,
                        'religious', landUseColors.religious,
                        'residential', landUseColors.residential,
                        'education', landUseColors.education,
                        'medical', landUseColors.medical,
                        'transportation', landUseColors.transportation,
                        landUseColors['']
                    ],
                    'fill-opacity': 0.75,
                    'fill-antialias': true
                }
            });

            // Layer hover
            map.addLayer({
                id: 'catastale-hover',
                type: 'fill',
                source: 'palermo_catastale',
                'source-layer': 'catastale',
                paint: {
                    'fill-color': '#ff9900',
                    'fill-opacity': 0.8
                },
                filter: ['==', ['get', 'fid'], '']
            });

            // Layer contorni - inizialmente nascosti
            map.addLayer({
                id: 'catastale-outline',
                type: 'line',
                source: 'palermo_catastale',
                'source-layer': 'catastale',
                paint: {
                    'line-color': '#333333',
                    'line-width': 0.5,
                    'line-opacity': 0.6
                },
                layout: {
                    'visibility': 'none'
                }
            });

            // LAYER PERIMETRI AGGIUNTIVI
            
            // Perimetro Palermo - tratteggio lungo (12px line, 8px gap)
            map.addLayer({
                id: 'palermo-perimeter',
                type: 'line',
                source: 'palermo_catastale',
                'source-layer': 'Palermo',
                paint: {
                    'line-color': '#4a4a4a',
                    'line-width': 2,
                    'line-opacity': 0.8,
                    'line-dasharray': [12, 8]
                },
                layout: {
                    'visibility': 'none'
                }
            }, 'catastale-hover');
            
            // Controlli navigazione
            map.addControl(new maplibregl.NavigationControl());
            
            // Imposta il valore di default per uso del suolo
            document.getElementById('territorial-select').value = 'landuse';
            
            // Mostra legenda di base
            showBaseLegend();
        });

        // Aspetta che i dati siano caricati prima di caricare i dati
        map.on('sourcedata', function(e) {
            if (e.sourceId === 'palermo_catastale' && e.isSourceLoaded) {
                // Carica i dati disponibili solo quando i dati sono pronti
                loadAvailableData();
            }
        });

        // Funzione semplificata per caricare i dati disponibili
        function loadAvailableData() {
            try {
                setTimeout(() => {
                    console.log('Caricamento dati iniziato...');
                    
                    const features = map.querySourceFeatures('palermo_catastale', {
                        sourceLayer: 'catastale'
                    });
                    
                    console.log('Features trovate:', features.length);
                    
                    if (features.length === 0) {
                        console.warn('Nessuna feature trovata, riprovo...');
                        setTimeout(loadAvailableData, 1000);
                        return;
                    }
                    
                    // Salva le features in cache
                    allFeatures = features;
                    
                    // Estrai fogli e mandamenti unici
                    const fogli = new Set();
                    const mandamenti = new Set();
                    
                    features.forEach(feature => {
                        if (feature.properties) {
                            if (feature.properties.foglio) {
                                fogli.add(feature.properties.foglio);
                            }
                            if (feature.properties.Mandamento) {
                                mandamenti.add(feature.properties.Mandamento);
                            }
                        }
                    });
                    
                    // Ordina fogli
                    availableFogli = Array.from(fogli).sort((a, b) => {
                        const numA = parseInt(a);
                        const numB = parseInt(b);
                        if (!isNaN(numA) && !isNaN(numB)) {
                            return numA - numB;
                        }
                        return a.toString().localeCompare(b.toString());
                    });
                    
                    // Ordina mandamenti
                    availableMandamenti = Array.from(mandamenti).sort();
                    
                    console.log('Fogli caricati:', availableFogli);
                    console.log('Mandamenti caricati:', availableMandamenti);
                    
                    // Popola i dropdown iniziali
                    populateInitialDropdowns();
                    
                }, 500);
                
            } catch (error) {
                console.error('Errore nel caricamento dei dati:', error);
                // Fallback
                availableFogli = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'];
                availableMandamenti = ['Castellammare', 'Tribunali', 'Palazzo Reale', 'Monte di Piet√†'];
                populateInitialDropdowns();
            }
        }

        // Popola i dropdown iniziali con tutti i valori
        function populateInitialDropdowns() {
            console.log('Popolando dropdown iniziali...');
            
            // Popola mandamenti
            const mandamentoSelect = document.getElementById('mandamento-filter');
            mandamentoSelect.innerHTML = '<option value="">Tutti i Mandamenti</option>';
            
            availableMandamenti.forEach(mandamento => {
                const option = document.createElement('option');
                option.value = mandamento;
                // Correggi il nome per la visualizzazione
                const displayName = mandamento === 'Castellamare' ? 'Castellammare' : mandamento;
                option.textContent = displayName;
                mandamentoSelect.appendChild(option);
            });
            
            // Popola fogli
            const foglioSelect = document.getElementById('foglio-filter');
            foglioSelect.innerHTML = '<option value="">Tutti i Fogli</option>';
            
            availableFogli.forEach(foglio => {
                const option = document.createElement('option');
                option.value = foglio;
                option.textContent = `Foglio ${foglio}`;
                foglioSelect.appendChild(option);
            });
            
            console.log('Dropdown popolati con successo');
        }

        // Funzione semplificata per aggiornare fogli in base al mandamento
        function updateFoglioOptionsForMandamento(mandamento) {
            console.log('Aggiornamento fogli per mandamento:', mandamento);
            
            const foglioSelect = document.getElementById('foglio-filter');
            const currentFoglioValue = foglioSelect.value;
            
            // Se non c'√® mandamento, mostra tutti i fogli
            if (!mandamento) {
                foglioSelect.innerHTML = '<option value="">Tutti i Fogli</option>';
                availableFogli.forEach(foglio => {
                    const option = document.createElement('option');
                    option.value = foglio;
                    option.textContent = `Foglio ${foglio}`;
                    foglioSelect.appendChild(option);
                });
                
                // Ripristina selezione se possibile
                if (currentFoglioValue && availableFogli.includes(currentFoglioValue)) {
                    foglioSelect.value = currentFoglioValue;
                }
                return;
            }
            
            try {
                // Trova i fogli per questo mandamento
                let dbMandamento = mandamento === 'Castellammare' ? 'Castellamare' : mandamento;
                
                const featuresForMandamento = allFeatures.filter(f => 
                    f.properties && f.properties.Mandamento === dbMandamento
                );
                
                const fogliForMandamento = [...new Set(
                    featuresForMandamento
                        .map(f => f.properties.foglio)
                        .filter(f => f)
                )].sort((a, b) => {
                    const numA = parseInt(a);
                    const numB = parseInt(b);
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return numA - numB;
                    }
                    return a.toString().localeCompare(b.toString());
                });
                
                console.log(`Fogli trovati per ${dbMandamento}:`, fogliForMandamento);
                
                // Aggiorna dropdown
                foglioSelect.innerHTML = '<option value="">Tutti i Fogli</option>';
                fogliForMandamento.forEach(foglio => {
                    const option = document.createElement('option');
                    option.value = foglio;
                    option.textContent = `Foglio ${foglio}`;
                    foglioSelect.appendChild(option);
                });
                
                // Ripristina selezione se ancora valida
                if (currentFoglioValue && fogliForMandamento.includes(currentFoglioValue)) {
                    foglioSelect.value = currentFoglioValue;
                } else if (currentFoglioValue && !fogliForMandamento.includes(currentFoglioValue)) {
                    currentFoglioFilter = null;
                }
                
            } catch (error) {
                console.error('Errore aggiornamento fogli:', error);
            }
        }

        // Funzione semplificata per aggiornare mandamenti in base al foglio
        function updateMandamentoOptionsForFoglio(foglio) {
            console.log('Aggiornamento mandamenti per foglio:', foglio);
            
            const mandamentoSelect = document.getElementById('mandamento-filter');
            const currentMandamentoValue = mandamentoSelect.value;
            
            // Se non c'√® foglio, mostra tutti i mandamenti
            if (!foglio) {
                mandamentoSelect.innerHTML = '<option value="">Tutti i Mandamenti</option>';
                availableMandamenti.forEach(mandamento => {
                    const option = document.createElement('option');
                    option.value = mandamento;
                    const displayName = mandamento === 'Castellamare' ? 'Castellammare' : mandamento;
                    option.textContent = displayName;
                    mandamentoSelect.appendChild(option);
                });
                
                // Ripristina selezione se possibile
                if (currentMandamentoValue && availableMandamenti.includes(currentMandamentoValue)) {
                    mandamentoSelect.value = currentMandamentoValue;
                }
                return;
            }
            
            try {
                // Trova i mandamenti per questo foglio
                const featuresForFoglio = allFeatures.filter(f => 
                    f.properties && f.properties.foglio && f.properties.foglio.toString() === foglio.toString()
                );
                
                const mandamentiForFoglio = [...new Set(
                    featuresForFoglio
                        .map(f => f.properties.Mandamento)
                        .filter(m => m)
                )].sort();
                
                console.log(`Mandamenti trovati per foglio ${foglio}:`, mandamentiForFoglio);
                
                // Aggiorna dropdown
                mandamentoSelect.innerHTML = '<option value="">Tutti i Mandamenti</option>';
                mandamentiForFoglio.forEach(mandamento => {
                    const option = document.createElement('option');
                    option.value = mandamento;
                    const displayName = mandamento === 'Castellamare' ? 'Castellammare' : mandamento;
                    option.textContent = displayName;
                    mandamentoSelect.appendChild(option);
                });
                
                // Ripristina selezione se ancora valida
                if (currentMandamentoValue && mandamentiForFoglio.includes(currentMandamentoValue)) {
                    mandamentoSelect.value = currentMandamentoValue;
                } else if (currentMandamentoValue && !mandamentiForFoglio.includes(currentMandamentoValue)) {
                    currentMandamentoFilter = null;
                }
                
            } catch (error) {
                console.error('Errore aggiornamento mandamenti:', error);
            }
        }

        // Gestione hover
        map.on('mouseenter', 'catastale-base', (e) => {
            map.getCanvas().style.cursor = 'pointer';
            
            if (e.features.length > 0) {
                const feature = e.features[0];
                const featureId = feature.properties.fid || feature.properties.particella || feature.id;
                
                if (hoveredPolygon !== null) {
                    map.setFilter('catastale-hover', ['==', ['get', 'fid'], '']);
                }
                
                hoveredPolygon = featureId;
                map.setFilter('catastale-hover', [
                    'any',
                    ['==', ['get', 'fid'], featureId],
                    ['==', ['get', 'particella'], featureId]
                ]);
            }
        });

        map.on('mouseleave', 'catastale-base', () => {
            map.getCanvas().style.cursor = '';
            
            if (hoveredPolygon !== null) {
                map.setFilter('catastale-hover', ['==', ['get', 'fid'], '']);
            }
            hoveredPolygon = null;
        });

        // Gestione click
        map.on('click', 'catastale-base', (e) => {
            if (e.features.length > 0) {
                const feature = e.features[0];
                showFeatureInfo(feature);
            }
        });

        // Funzioni controllo perimetri
        function togglePerimeter(layerId, show) {
            const visibility = show ? 'visible' : 'none';
            map.setLayoutProperty(layerId, 'visibility', visibility);
        }

        // Funzioni tematizzazione
        function applyTheme(themeKey) {
            const theme = themes[themeKey];
            if (!theme) return;

            // Calcola range dinamico basato sui filtri attivi
            const dynamicRange = calculateDynamicRange(themeKey);
            const range = dynamicRange || getStaticRange(themeKey);
            const step = (range.max - range.min) / (theme.colors.length - 1);

            // Rimuovi layer tematico esistente se presente
            if (map.getLayer('catastale-thematic')) {
                map.removeLayer('catastale-thematic');
            }

            // Ottieni il filtro corrente
            const currentFilter = getCurrentFilter();

            // Configura il layer
            const layerConfig = {
                id: 'catastale-thematic',
                type: 'fill',
                source: 'palermo_catastale',
                'source-layer': 'catastale',
                paint: {
                    'fill-color': [
                        'interpolate',
                        ['linear'],
                        ['coalesce', ['get', theme.property], range.min],
                        range.min, theme.colors[0],
                        range.min + step, theme.colors[1],
                        range.min + (step * 2), theme.colors[2],
                        range.min + (step * 3), theme.colors[3],
                        range.min + (step * 4), theme.colors[4],
                        range.min + (step * 5), theme.colors[5],
                        range.min + (step * 6), theme.colors[6],
                        range.max, theme.colors[7]
                    ],
                    'fill-opacity': 0.8
                }
            };

            // Aggiungi filtro solo se presente
            if (currentFilter) {
                layerConfig.filter = currentFilter;
            }

            // Aggiungi layer
            map.addLayer(layerConfig, 'catastale-outline');

            // Nascondi layer base
            map.setPaintProperty('catastale-base', 'fill-opacity', 0);
            
            currentTheme = themeKey;
            showLegend(theme, range);
        }

        function calculateDynamicRange(themeKey) {
            // Simula il calcolo del range dai dati filtrati
            // In un'implementazione reale, questo dovrebbe query i dati effettivi
            if (!currentMandamentoFilter && !currentFoglioFilter) return null;
            
            const theme = themes[themeKey];
            if (!theme) return null;
            
            // Range ridotti per simulare l'effetto del filtro
            const filteredRanges = {
                population: { min: 0, max: 800 },
                age: { min: 0, max: 90 },
                elderly: { min: 0, max: 80 },
                density: { min: 0, max: 15000 },
                foreign: { min: 0, max: 80 },
                employment: { min: 0, max: 90 },
                genderGap: { min: 0, max: 80 },
                education: { min: 0, max: 90 },
                resilience: { min: 0, max: 90 },
                cohesion: { min: 0, max: 90 },
                buildings: { min: 0, max: 40 }
            };
            
            return filteredRanges[themeKey];
        }

        function getStaticRange(themeKey) {
            // Range valori - tutti iniziano da 0
            const valueRanges = {
                population: { min: 0, max: 1000 },
                age: { min: 0, max: 100 },
                elderly: { min: 0, max: 100 },
                density: { min: 0, max: 20000 },
                foreign: { min: 0, max: 100 },
                employment: { min: 0, max: 100 },
                genderGap: { min: 0, max: 100 },
                education: { min: 0, max: 100 },
                resilience: { min: 0, max: 100 },
                cohesion: { min: 0, max: 100 },
                buildings: { min: 0, max: 50 }
            };
            
            return valueRanges[themeKey];
        }

        function getCurrentFilter() {
            const filters = [];
            
            // Filtro mandamento
            if (currentMandamentoFilter && currentMandamentoFilter !== '') {
                let dbMandamento = currentMandamentoFilter;
                if (currentMandamentoFilter === 'Castellammare') {
                    dbMandamento = 'Castellamare';
                }
                filters.push(['==', ['get', 'Mandamento'], dbMandamento]);
            }
            
            // Filtro foglio
            if (currentFoglioFilter && currentFoglioFilter !== '') {
                // Converti in stringa per essere sicuri
                const foglioStr = currentFoglioFilter.toString();
                filters.push(['==', ['to-string', ['get', 'foglio']], foglioStr]);
            }
            
            console.log('Filtri costruiti:', filters);
            
            // Combina i filtri
            if (filters.length === 0) {
                console.log('Nessun filtro attivo - ritorno null');
                return null;
            } else if (filters.length === 1) {
                console.log('Un solo filtro - ritorno:', filters[0]);
                return filters[0];
            } else {
                const combinedFilter = ['all', ...filters];
                console.log('Filtri combinati:', combinedFilter);
                return combinedFilter;
            }
        }

        function applyMandamentoFilter(mandamento) {
            console.log('=== FILTRO MANDAMENTO ===');
            console.log('Mandamento selezionato:', mandamento);
            
            const activeTheme = currentTheme;
            currentMandamentoFilter = mandamento || null;
            
            // Aggiorna i fogli disponibili SOLO se abbiamo i dati caricati
            if (allFeatures.length > 0) {
                updateFoglioOptionsForMandamento(mandamento);
            }
            
            // Applica filtri e aggiorna mappa
            applyFilters();
            
            if (activeTheme && activeTheme !== 'landuse') {
                applyTheme(activeTheme);
            } else {
                if (map.getLayer('catastale-thematic')) {
                    map.removeLayer('catastale-thematic');
                }
                map.setPaintProperty('catastale-base', 'fill-opacity', 0.75);
                showBaseLegend();
            }
        }

        function applyFoglioFilter(foglio) {
            console.log('=== FILTRO FOGLIO ===');
            console.log('Foglio selezionato:', foglio);
            
            const activeTheme = currentTheme;
            currentFoglioFilter = foglio || null;
            
            // Aggiorna i mandamenti disponibili SOLO se abbiamo i dati caricati
            if (allFeatures.length > 0) {
                updateMandamentoOptionsForFoglio(foglio);
            }
            
            // Applica filtri e aggiorna mappa
            applyFilters();
            
            if (activeTheme && activeTheme !== 'landuse') {
                applyTheme(activeTheme);
            } else {
                if (map.getLayer('catastale-thematic')) {
                    map.removeLayer('catastale-thematic');
                }
                map.setPaintProperty('catastale-base', 'fill-opacity', 0.75);
                showBaseLegend();
            }
        }

        function applyFilters() {
            const filter = getCurrentFilter();
            
            console.log('=== APPLICA FILTRI ===');
            console.log('Stato filtri:', {
                mandamento: currentMandamentoFilter,
                foglio: currentFoglioFilter,
                filter: filter
            });
            
            // Applica filtro ai layer base
            if (filter) {
                console.log('Applicando filtro ai layer...');
                map.setFilter('catastale-base', filter);
                map.setFilter('catastale-outline', filter);
            } else {
                console.log('Rimuovendo tutti i filtri dai layer...');
                map.setFilter('catastale-base', null);
                map.setFilter('catastale-outline', null);
            }
            
            // Reset hover sempre
            map.setFilter('catastale-hover', ['==', ['get', 'fid'], '']);
            
            // Assicurati che il layer base sia sempre visibile
            map.setPaintProperty('catastale-base', 'fill-opacity', 0.75);
            
            console.log('=== FINE APPLICA FILTRI ===');
        }

        function updateFoglioOptionsForMandamento(mandamento) {
            if (!mandamento) {
                // Se non c'√® un mandamento selezionato, mostra tutti i fogli
                populateFoglioSelect();
                // IMPORTANTE: Mantieni la selezione del foglio corrente
                const foglioSelect = document.getElementById('foglio-filter');
                if (currentFoglioFilter) {
                    setTimeout(() => {
                        foglioSelect.value = currentFoglioFilter;
                    }, 50);
                }
                return;
            }
            
            try {
                // Aspetta che i dati siano disponibili
                setTimeout(() => {
                    // Query delle features per il mandamento specifico
                    let dbMandamento = mandamento;
                    if (mandamento === 'Castellammare') {
                        dbMandamento = 'Castellamare';
                    }
                    
                    const features = map.querySourceFeatures('palermo_catastale', {
                        sourceLayer: 'catastale'
                    });
                    
                    // Filtra le features per mandamento
                    const filteredFeatures = features.filter(feature => 
                        feature.properties && feature.properties.Mandamento === dbMandamento
                    );
                    
                    console.log(`Features per mandamento ${dbMandamento}:`, filteredFeatures.length);
                    
                    // Estrai i fogli unici per questo mandamento
                    const fogli = new Set();
                    filteredFeatures.forEach(feature => {
                        if (feature.properties && feature.properties.foglio) {
                            fogli.add(feature.properties.foglio);
                        }
                    });
                    
                    console.log(`Fogli per mandamento ${dbMandamento}:`, Array.from(fogli));
                    
                    const fogliFiltrati = Array.from(fogli).sort((a, b) => {
                        const numA = parseInt(a);
                        const numB = parseInt(b);
                        if (!isNaN(numA) && !isNaN(numB)) {
                            return numA - numB;
                        }
                        return a.toString().localeCompare(b.toString());
                    });
                    
                    // SALVA il valore correntemente selezionato
                    const foglioSelect = document.getElementById('foglio-filter');
                    const savedFoglioFilter = currentFoglioFilter; // Salva lo stato
                    
                    // Aggiorna il dropdown SENZA toccare la variabile currentFoglioFilter
                    // Rimuovi tutte le opzioni tranne la prima
                    while (foglioSelect.children.length > 1) {
                        foglioSelect.removeChild(foglioSelect.lastChild);
                    }
                    
                    // Aggiungi le opzioni filtrate
                    if (fogliFiltrati.length > 0) {
                        fogliFiltrati.forEach(foglio => {
                            const option = document.createElement('option');
                            option.value = foglio;
                            option.textContent = `Foglio ${foglio}`;
                            foglioSelect.appendChild(option);
                        });
                    } else {
                        // Se non ci sono fogli per questo mandamento, usa tutti i fogli disponibili
                        availableFogli.forEach(foglio => {
                            const option = document.createElement('option');
                            option.value = foglio;
                            option.textContent = `Foglio ${foglio}`;
                            foglioSelect.appendChild(option);
                        });
                    }
                    
                    // RIPRISTINA il valore selezionato se ancora disponibile
                    if (savedFoglioFilter && (fogliFiltrati.includes(savedFoglioFilter.toString()) || !fogliFiltrati.length)) {
                        setTimeout(() => {
                            foglioSelect.value = savedFoglioFilter;
                            currentFoglioFilter = savedFoglioFilter; // Ripristina anche la variabile
                        }, 10);
                    } else if (savedFoglioFilter && !fogliFiltrati.includes(savedFoglioFilter.toString())) {
                        // Reset solo se il foglio non √® pi√π disponibile
                        currentFoglioFilter = null;
                        setTimeout(() => {
                            foglioSelect.value = '';
                        }, 10);
                    }
                    
                }, 100);
                
            } catch (error) {
                console.warn('Errore nell\'aggiornamento dei fogli per mandamento:', error);
                populateFoglioSelect(); // Fallback al set completo
            }
        }

        function toggleBorders(show) {
            const visibility = show ? 'visible' : 'none';
            map.setLayoutProperty('catastale-outline', 'visibility', visibility);
        }

        function removeTheme() {
            if (map.getLayer('catastale-thematic')) {
                map.removeLayer('catastale-thematic');
            }
            
            // Ripristina layer base con opacit√† corretta
            map.setPaintProperty('catastale-base', 'fill-opacity', 0.75);
            
            // Applica i filtri correnti al layer base
            const filter = getCurrentFilter();
            map.setFilter('catastale-base', filter);
            
            currentTheme = 'landuse';
            showBaseLegend();
        }

        function showLegend(theme, range) {
            const legend = document.getElementById('legend');
            const title = document.getElementById('legend-title');
            const items = document.getElementById('legend-items');
            
            let titleText = theme.name;
            const filterParts = [];
            if (currentMandamentoFilter) {
                filterParts.push(currentMandamentoFilter);
            }
            if (currentFoglioFilter) {
                filterParts.push(`Foglio ${currentFoglioFilter}`);
            }
            if (filterParts.length > 0) {
                titleText += ` - ${filterParts.join(', ')}`;
            }
            title.textContent = titleText;
            
            items.innerHTML = '';
            
            const step = (range.max - range.min) / (theme.colors.length - 1);
            
            theme.colors.forEach((color, i) => {
                const minVal = Math.round(range.min + (step * i));
                const maxVal = i === theme.colors.length - 1 ? 
                    range.max : 
                    Math.round(range.min + (step * (i + 1)));
                
                const item = document.createElement('div');
                item.className = 'legend-item';
                
                let label = `${minVal} - ${maxVal} ${theme.unit}`;
                
                item.innerHTML = `
                    <div class="legend-color" style="background-color: ${color}"></div>
                    <span class="legend-label">${label}</span>
                `;
                items.appendChild(item);
            });
            
            legend.classList.add('visible');
        }

        function showBaseLegend() {
            const legend = document.getElementById('legend');
            const title = document.getElementById('legend-title');
            const items = document.getElementById('legend-items');
            
            let titleText = 'Base catastale';
            const filterParts = [];
            if (currentMandamentoFilter) {
                filterParts.push(currentMandamentoFilter);
            }
            if (currentFoglioFilter) {
                filterParts.push(`Foglio ${currentFoglioFilter}`);
            }
            if (filterParts.length > 0) {
                titleText += ` - ${filterParts.join(', ')}`;
            }
            title.textContent = titleText;
            
            items.innerHTML = '';
            
            for (const [className, color] of Object.entries(landUseColors)) {
                if (className === '') continue; // Salta il non classificato
                
                const label = landUseLabels[className];
                
                const item = document.createElement('div');
                item.className = 'legend-item';
                
                item.innerHTML = `
                    <div class="legend-color" style="background-color: ${color}"></div>
                    <span class="legend-label">${label}</span>
                `;
                items.appendChild(item);
            }
            
            legend.classList.add('visible');
        }

        // Pannello informazioni
        function showFeatureInfo(feature) {
            const panel = document.getElementById('info-panel');
            const title = document.getElementById('panel-title');
            const subtitle = document.getElementById('panel-subtitle');
            const content = document.getElementById('info-content');
            
            const props = feature.properties;
            
            // Correggi il nome del mandamento se necessario
            let mandamentoDisplay = props.Mandamento || 'N/D';
            if (mandamentoDisplay === 'Castellamare') {
                mandamentoDisplay = 'Castellammare';
            }
            
            title.textContent = `Particella ${props.particella || props.fid || 'N/D'}`;
            subtitle.textContent = `Foglio: ${props.foglio || 'N/D'}`;
            
            content.innerHTML = `
                <div class="info-group">
                    <h3>üìç Informazioni Generali</h3>
                    <div class="info-item">
                        <span class="info-label">Particella:</span>
                        <span class="info-value">${props.particella || 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Foglio:</span>
                        <span class="info-value">${props.foglio || 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Mandamento:</span>
                        <span class="info-value">${mandamentoDisplay}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Superficie:</span>
                        <span class="info-value">${props['superfice mq'] ? props['superfice mq'].toLocaleString() + ' m¬≤' : 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Classe:</span>
                        <span class="info-value">${landUseLabels[props.class] || props.class || 'N/D'}</span>
                    </div>
					                    <div class="info-item">
                        <span class="info-label">Sottoclasse:</span>
                        <span class="info-value">${landUseLabels[props.subtype] || props.subtype || 'N/D'}</span>
                    </div>
                </div>

                <div class="info-group">
                    <h3>üë• Demografia</h3>
                    <div class="info-item">
                        <span class="info-label">Popolazione Stimata:</span>
                        <span class="info-value">${props.popolazione_stimata || 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Et√† Media:</span>
                        <span class="info-value">${props['et√†_media'] ? props['et√†_media'] + ' anni' : 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Tasso Anziani:</span>
                        <span class="info-value">${props.tasso_anziani ? props.tasso_anziani + '%' : 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Densit√† Abitativa:</span>
                        <span class="info-value">${props['densit√† abitativa'] ? props['densit√† abitativa'].toLocaleString() + ' ab/km¬≤' : 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Popolazione Straniera:</span>
                        <span class="info-value">${props.tasso_di_popolazione_straniera ? props.tasso_di_popolazione_straniera + '%' : 'N/D'}</span>
                    </div>
                </div>

                <div class="info-group">
                    <h3>üíº Socio-Economici</h3>
                    <div class="info-item">
                        <span class="info-label">Tasso Occupazione:</span>
                        <span class="info-value">${props.tasso_di_occupazione ? props.tasso_di_occupazione + '%' : 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Occup. Femminile:</span>
                        <span class="info-value">${props['tasso di occupazione femminile'] ? props['tasso di occupazione femminile'] + '%' : 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Divario Genere:</span>
                        <span class="info-value">${props['divario di genere nell\'occupazione'] ? props['divario di genere nell\'occupazione'] + '%' : 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Istruzione Superiore:</span>
                        <span class="info-value">${props['tasso di istruzione superiore'] ? props['tasso di istruzione superiore'] + '%' : 'N/D'}</span>
                    </div>
                </div>

                <div class="info-group">
                    <h3>üìä Indici</h3>
                    <div class="info-item">
                        <span class="info-label">Resilienza Economica:</span>
                        <span class="info-value">${props['indice_di_resilienza_economica'] || 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Coesione Sociale:</span>
                        <span class="info-value">${props.indice_coesione_sociale || 'N/D'}</span>
                    </div>
                </div>

                <div class="info-group">
                    <h3>üèóÔ∏è Territoriali</h3>
                    <div class="info-item">
                        <span class="info-label">Numero Edifici:</span>
                        <span class="info-value">${props.buildings_count || 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">CAP:</span>
                        <span class="info-value">${props.postal_code || 'N/D'}</span>
                    </div>
                </div>
            `;
            
            panel.classList.add('visible');
        }

        function closeInfoPanel() {
            document.getElementById('info-panel').classList.remove('visible');
        }

        // Event listeners per i controlli
        function switchBasemap(value) {
            const layers = ['carto-light-layer', 'satellite-layer'];
            const targetLayer = value === 'carto-light' ? 'carto-light-layer' : 'satellite-layer';
            
            layers.forEach(layerId => {
                const visibility = (layerId === targetLayer) ? 'visible' : 'none';
                map.setLayoutProperty(layerId, 'visibility', visibility);
            });
        }

        function resetAllSelects(exceptId) {
            const selects = ['demographic-select', 'economic-select', 'territorial-select'];
            selects.forEach(selectId => {
                if (selectId !== exceptId) {
                    document.getElementById(selectId).value = '';
                }
            });
        }

        function activateTheme(themeKey) {
            if (themeKey === 'landuse' || themeKey === '' || !themeKey) {
                removeTheme();
            } else {
                applyTheme(themeKey);
            }
        }

        // Event listeners per dropdown
        document.getElementById('basemap-select').addEventListener('change', (e) => {
            switchBasemap(e.target.value);
        });

        // Event listeners semplificati
        document.getElementById('mandamento-filter').addEventListener('change', (e) => {
            console.log('Cambio mandamento:', e.target.value);
            applyMandamentoFilter(e.target.value);
        });

        document.getElementById('foglio-filter').addEventListener('change', (e) => {
            console.log('Cambio foglio:', e.target.value);
            applyFoglioFilter(e.target.value);
        });

        document.getElementById('borders-toggle').addEventListener('change', (e) => {
            toggleBorders(e.target.checked);
        });

        // Event listeners per perimetri
        document.getElementById('palermo-perimeter').addEventListener('change', (e) => {
            togglePerimeter('palermo-perimeter', e.target.checked);
        });

        document.getElementById('centro-storico-perimeter').addEventListener('change', (e) => {
            togglePerimeter('centro-storico-perimeter', e.target.checked);
        });

        document.getElementById('upl-cs-perimeter').addEventListener('change', (e) => {
            togglePerimeter('upl-cs-perimeter', e.target.checked);
        });

        document.getElementById('demographic-select').addEventListener('change', (e) => {
            if (e.target.value) {
                resetAllSelects('demographic-select');
                activateTheme(e.target.value);
            } else {
                activateTheme('landuse');
            }
        });

        document.getElementById('economic-select').addEventListener('change', (e) => {
            if (e.target.value) {
                resetAllSelects('economic-select');
                activateTheme(e.target.value);
            } else {
                activateTheme('landuse');
            }
        });

        document.getElementById('territorial-select').addEventListener('change', (e) => {
            if (e.target.value) {
                resetAllSelects('territorial-select');
                activateTheme(e.target.value);
            } else {
                activateTheme('landuse');
            }
        });

        // Gestione responsive
        window.addEventListener('resize', () => {
            if (window.innerWidth <= 768) {
                const panel = document.getElementById('info-panel');
                if (panel.classList.contains('visible')) {
                    panel.style.width = `${window.innerWidth - 20}px`;
                }
            }
        });

        // Gestione tastiera
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeInfoPanel();
            }
        });
    </script>
	   <!-- loghi  --> 
<div id="tavolab"></div>           
<div id="ods"><a href="https://opendatasicilia.it/" title="opendatasicilia.it" target="_blank"> 
<img src="https://palermohub.opendatasicilia.it/lib/images/opendatasicilia_dredits.png" alt="opendatasicilia" width="40" border="0" title="opendatasicilia.it"></a></div>    
<!-- beta version     --> 
 <div id="beta"><img src="https://palermohub.opendatasicilia.it/legend/beta.png" width="40" title="beta version" alt="beta version"></a></div>
</body>
</html>ale-hover');

            // Centro Storico - tratteggio medio (8px line, 6px gap)
            map.addLayer({
                id: 'centro-storico-perimeter',
                type: 'line',
                source: 'palermo_catastale',
                'source-layer': 'centro_storico',
                paint: {
                    'line-color': '#4a4a4a',
                    'line-width': 1.5,
                    'line-opacity': 0.8,
                    'line-dasharray': [8, 6]
                },
                layout: {
                    'visibility': 'none'
                }
            }, 'catastale-hover');

            // UPL Centro Storico - tratteggio corto (4px line, 4px gap)
            map.addLayer({
                id: 'upl-cs-perimeter',
                type: 'line',
                source: 'palermo_catastale',
                'source-layer': 'upl_cs',
                paint: {
                    'line-color': '#4a4a4a',
                    'line-width': 1,
                    'line-opacity': 0.8,
                    'line-dasharray': [4, 4]
                },
                layout: {
                    'visibility': 'visible'
                }
            }, 'catast