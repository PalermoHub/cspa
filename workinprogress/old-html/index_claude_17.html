<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Studio Demografico e Socio-Economico del Centro Storico di  Palermo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="shortcut icon" href="https://palermohub.opendatasicilia.it/favicon.ico"/> 
    <link rel="icon" href="https://palermohub.opendatasicilia.it/favicon.png" type="image/png"/> 
	 <link rel="stylesheet" href="css/cspa.css">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Librerie MapLibre -->
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <!-- Libreria PMTiles -->
    <script src="https://unpkg.com/pmtiles@2.4.0/dist/index.js"></script>

</head>
<body>
    <div class="header">
        <h1><img src="img/logo_cs.svg" alt="cspa" width="40" height="40"/> Studio Demografico e Socio-Economico del Centro Storico di  Palermo</h1>
    </div>

    <div id="map"></div>
    
    <div class="control-panel">
        <div class="control-section">
            <h3><img src="img/map_01.svg" alt="cspa" width="20" height="20"/> Seleziona la mappa base</h3>
            <select id="basemap-select" class="form-control">
                <option value="carto-light">CartoDB Light</option>
				<option value="osm">OSM Standard</option>
        <option value="google-maps">Google Maps</option>
                <option value="satellite">Google Satellite</option>
            </select>
        </div>
        
        <div class="control-section">
            <h3><img src="img/logo_cs.svg" alt="cspa" width="20" height="20"/>Filtra per Mandamenti</h3>
            <select id="mandamento-filter" class="form-control">
                <option value="">Tutti i Mandamenti</option>
                <option value="Castellammare">Castellammare</option>
                <option value="Tribunali">Tribunali</option>
                <option value="Palazzo Reale">Palazzo Reale</option>
                <option value="Monte di Pietà">Monte di Pietà</option>
            </select>
        </div>
        
        <div class="control-section">
            <h3><img src="img/people.svg" alt="cspa" width="20" height="20"/> Indicatori Demografici</h3>
            <select id="demographic-select" class="form-control">
                <option value="">Seleziona indicatore...</option>
        <option value="population"><i class="fas fa-users"></i> Popolazione Stimata</option>
				 <option value="masculinity"><i class="fas fa-mars"></i> Tasso di Mascolinità</option>
        <option value="singlePerson"><i class="fas fa-user"></i> Tasso Persona Singola</option>
        <option value="familySize"><i class="fas fa-home-heart"></i> Dimensione Media Famiglia</option>
        <option value="largeFamilies"><i class="fas fa-users"></i> Tasso Famiglie Numerose</option>
        <option value="age"><i class="fas fa-user-clock"></i> Età Media</option>
	    <option value="elderly"><i class="fas fa-user-friends"></i> Tasso Anziani</option>
        <option value="foreign"><i class="fas fa-globe"></i> Popolazione Straniera</option>		
        <option value="nonEuForeigners"><i class="fas fa-passport"></i> Stranieri Non-UE</option>
        <option value="youngForeigners"><i class="fas fa-child"></i> Giovani Stranieri</option>
            </select>
        </div>
        
        <div class="control-section">
            <h3><img src="img/people_02.svg" alt="cspa" width="20" height="20"/> Indicatori Socio-Economici</h3>
            <select id="economic-select" class="form-control">
                <option value="">Seleziona indicatore...</option>
	   <option value="higherEducation"><i class="fas fa-graduation-cap"></i> Istruzione Superiore</option>
       <option value="lowEducation"><i class="fas fa-book"></i> Basso Tasso Istruzione</option>
	   <option value="workIntegration"><i class="fas fa-handshake"></i> Integrazione Lavoro</option>
       <option value="employment"><i class="fas fa-briefcase"></i> Tasso Occupazione</option>
      <option value="femaleEmployment"><i class="fas fa-female"></i> Tasso Occupazione Femminile</option>
       <option value="genderGap"><i class="fas fa-balance-scale"></i> Divario Genere Occupazione</option>
      <option value="resilience"><i class="fas fa-shield-alt"></i> Resilienza Economica</option>
     <option value="cohesion"><i class="fas fa-handshake"></i> Coesione Sociale</option>
            </select>
        </div>
        
        <div class="control-section">
            <h3><img src="img/chart-area.svg" alt="cspa" width="20" height="20"/> Indicatori Territoriali</h3>
            <select id="territorial-select" class="form-control">
                <option value="landuse">Seleziona indicatore...</option>
				<!-- <option value="landuse" selected><i class="fas fa-map-marked-alt"></i> Particelle catastali di base</option> -->
<option value="density"><i class="fas fa-home"></i> Densità Abitativa</option>
<option value="surface_area"><i class="fas fa-expand-arrows-alt"></i> Superficie Particella</option>
<option value="elevation_min"><i class="fas fa-mountain"></i> Quota al suolo Min</option>
<option value="elevation_max"><i class="fas fa-mountain"></i> Quota al suolo Max</option>
<option value="building_occupancy"><i class="fas fa-building"></i> Occupazione Media Edificio</option>
<option value="structural_dependency"><i class="fas fa-tools"></i> Dipendenza Strutturale</option>
<option value="robustness"><i class="fas fa-shield-alt"></i> Indice Robustezza</option>
<option value="requalification_opportunity"><i class="fas fa-hammer"></i> Opportunità Riqualificazione</option>
<option value="real_estate_potential"><i class="fas fa-chart-line"></i> Potenziale Immobiliare</option>
<option value="flood_risk"><i class="fas fa-water"></i> Rischio alluvione</option>
<option value="land_cover"><i class="fas fa-leaf"></i> Copertura del suolo</option>
<option value="landslide_risk"><i class="fas fa-mountain"></i> Rischio di frana</option>
<option value="coastal_erosion"><i class="fas fa-umbrella-beach"></i> Rischio erosione costiera</option>
<option value="seismic_risk"><i class="fas fa-quake"></i> Rischio sismico</option>
            </select>
        </div>
        
        <div class="control-section">
            <h3><img src="img/logo_cs_01.svg" alt="cspa" width="20" height="20"/> Perimetri</h3>
            <label class="checkbox-container">
                <input type="checkbox" id="palermo-perimeter">
                <span class="checkmark"></span>
                Limite Amministrativo Palermo
            </label>
            <label class="checkbox-container">
                <input type="checkbox" id="centro-storico-perimeter" >
                <span class="checkmark"></span>
                Centro Storico
            </label>
            <label class="checkbox-container">
                <input type="checkbox" id="upl-cs-perimeter" checked>
                <span class="checkmark"></span>
                Mandamenti
            </label>
        </div>
        
        <div class="control-section">
            <h3><img src="img/gear.svg" alt="cspa" width="20" height="20"/> Visualizzazione</h3>
            <label class="checkbox-container">
                <input type="checkbox" id="borders-toggle">
                <span class="checkmark"></span>
                Mostra bordi poligoni
            </label>
			    <button id="reset-map" class="reset-button" title="RESET Vista predefinita">
        <i class="fas fa-sync-alt" title="RESET Vista predefinita"></i> Vista predefinita
    </button>
        </div>
    </div>
    
    <div class="info-panel" id="info-panel">
        <div class="info-panel-header">
            <div>
                <h2 id="panel-title">Dettagli Particella</h2>
                <div id="panel-subtitle" style="font-size: 14px; opacity: 0.9; margin-top: 4px;"></div>
            </div>
            <button class="close-panel" onclick="closeInfoPanel()"><i class="fas fa-times"></i></button>
        </div>
        <div class="info-content" id="info-content">
            <p style="text-align: center; color: #7f8c8d; margin-top: 50px;">
                Clicca su una particella per visualizzarne i dettagli
            </p>
        </div>
    </div>
    
    <div class="legend" id="legend">
        <h4 id="legend-title">Legenda</h4>
        <div id="legend-items"></div>
    </div>

    <script>
        // Registra il protocollo PMTiles
        const protocol = new pmtiles.Protocol();
        maplibregl.addProtocol("pmtiles", protocol.tile);
        
        // Configurazione mappa
        const center = [13.3614, 38.1157];
        const zoom = 14;
        const maxBounds = [
            [13.32, 38.09],
            [13.40, 38.14]
        ];

        // Colori uso del suolo dal file QML
        const landUseColors = {
            "servizi": "rgba(250,240,230,0.75)",
            "military": "rgba(85,107,47,0.75)",
            "park": "rgba(124,252,0,0.75)",
            "pedestrian": "rgba(123,123,123,0.75)",
            "protected": "rgba(255,192,192,0.75)",
            "recreation": "rgba(111, 167, 183 , 75%)",
            "religious": "rgba(221,101,251,1.0)",
            "residential": "rgba(255,230,153,0.75)",
            "education": "rgba(226,160,54,0.75)",
            "medical": "rgba(222,37,37,0.75)",
            "transportation": "rgba(192,192,192,0.75)",
            "": "rgba(240,240,240,0.75)"
        };

        const landUseLabels = {
            "servizi": "Servizi",
            "military": "Militare",
            "park": "Verde Pubblico",
            "pedestrian": "Pedonale",
            "protected": "Storico",
            "recreation": "Ricreativo",
            "religious": "Religioso",
            "residential": "Residenziale",
            "education": "Educativo",
            "medical": "Ospedale",
            "transportation": "Trasporti",
            "": "Non Classificato"
        };

        // Definizioni per le nuove mappe tematiche
        const landCoverColors = {
            "1110": "rgba(255,255,100,0.7)",
            "2111": "rgba(34,139,34,0.7)",
            "2112": "rgba(152,251,152,0.7)",
            "2212": "rgba(0,100,0,0.7)"
        };

        const landCoverLabels = {
            "1110": "Aree urbane",
            "2111": "Colture permanenti",
            "2112": "Colture temporanee",
            "2212": "Foreste"
        };

        const floodRiskColors = {
            "high": "rgba(255,0,0,0.7)",
            "none": "rgba(200,200,200,0.5)"
        };

        const floodRiskLabels = {
            "high": "Alto rischio - R4",
            "none": "Nessun rischio"
        };

        const landslideRiskColors = {
            "none": "rgba(200,200,200,0.5)"
        };

        const landslideRiskLabels = {
            "none": "Nessun rischio"
        };

        const coastalErosionColors = {
            "none": "rgba(200,200,200,0.5)"
        };

        const coastalErosionLabels = {
            "none": "Nessun rischio"
        };

        const seismicRiskColors = {
            "low": "rgba(0,255,0,0.7)"
        };

        const seismicRiskLabels = {
            "low": "Basso rischio"
        };

        // Inizializza mappa
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'carto-light': {
                        type: 'raster',
                        tiles: ['https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png'],
                        tileSize: 256,
                        attribution: '© OpenStreetMap contributors, © CartoDB - Rielaborazione dataset di <a href="https://www.linkedin.com/in/gbvitrano/" title="@gbvitrano" target="_blank">@gbvitrano </a> -  '
                    },
                    'satellite': {
                        type: 'raster',
                        tiles: ['https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}'],
                        tileSize: 256,
                        attribution: '© Google - Rielaborazione dataset di <a href="https://www.linkedin.com/in/gbvitrano/" title="@gbvitrano" target="_blank">@gbvitrano </a> -'
                    },
					    'osm': {
        type: 'raster',
        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
        tileSize: 256,
        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors - Rielaborazione dataset di <a href="https://www.linkedin.com/in/gbvitrano/" title="@gbvitrano" target="_blank">@gbvitrano </a> -'
    },
    'google-maps': {
        type: 'raster',
        tiles: ['https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}'],
        tileSize: 256,
        attribution: '© Google Maps - Rielaborazione dataset di <a href="https://www.linkedin.com/in/gbvitrano/" title="@gbvitrano" target="_blank">@gbvitrano </a> -'
    }
      },
                layers: [
                    {
                        id: 'carto-light-layer',
                        type: 'raster',
                        source: 'carto-light',
                        minzoom: 0,
                        maxzoom: 17
                    },
                    {
                        id: 'satellite-layer',
                        type: 'raster',
                        source: 'satellite',
                        minzoom: 0,
                        maxZoom: 17,
                        layout: { visibility: 'none' }
                    },
		    {
        id: 'osm-layer',
        type: 'raster',
        source: 'osm',
        minzoom: 0,
        maxZoom: 19,
        layout: { visibility: 'none' }
    },
    {
        id: 'google-maps-layer',
        type: 'raster',
        source: 'google-maps',
        minzoom: 0,
        maxZoom: 19,
        layout: { visibility: 'none' }
    }	
	]
            },
            center: center,
            zoom: zoom,
            maxBounds: maxBounds,
            maxZoom: 17,
            minZoom: 12,
            hash: true,
            pitch: 0,
            dragRotate: false
        });

        // Configurazioni tematizzazioni AGGIORNATE con Jenks-Fisher per popolazione, età, tasso anziani
        const themes = {
            population: {
                name: 'Popolazione Stimata',
                property: 'popolazione_stimata',
                colors: ['#ffffff', '#bbdefb', '#90caf9', '#64b5f6', '#42a5f5', '#2196f3', '#1e88e5', '#1976d2'],
                unit: 'abitanti',
                format: (val) => `${val || 'N/D'} abitanti`,
                jenksBreaks: [0, 0, 1, 3, 6, 12, 20, 35], // Break points aggiornati per range 0-35
                type: 'jenks'
            },
			
			familySize: {
    name: 'Dimensione Media Famiglia',
    property: 'dimensione media della famiglia',
    colors: ['#ffffff', '#e8f5e8', '#c8e6c8', '#a5d6a5', '#82c782', '#5fb85f', '#3ca83c', '#2e7d32'],
    unit: 'componenti',
    format: (val) => `${val || 'N/D'} componenti`,
    jenksBreaks: [0, 0, 1.5, 2.2, 2.8, 3.5, 4.2, 5.0, 33],
    type: 'jenks'
},
masculinity: {
    name: 'Tasso di Mascolinità',
    property: 'tasso di mascolinità',
    colors: ['#ffffff', '#e3f2fd', '#bbdefb', '#90caf9', '#64b5f6', '#42a5f5', '#2196f3', '#1976d2'],
    unit: '%',
    format: (val) => `${val || 'N/D'}%`,
    jenksBreaks: [0, 0, 45, 50, 55, 60, 70, 85, 100],
    type: 'jenks'
},
singlePerson: {
    name: 'Tasso Persona Singola',
    property: 'tasso_persona singola',
    colors: ['#ffffff', '#fff3e0', '#ffe0b2', '#ffcc80', '#ffb74d', '#ffa726', '#ff9800', '#f57c00'],
    unit: '%',
    format: (val) => `${val || 'N/D'}%`,
    jenksBreaks: [0, 0, 15, 25, 35, 45, 60, 80, 100],
    type: 'jenks'
},
largeFamilies: {
    name: 'Tasso Famiglie Numerose',
    property: 'tasso_famiglie_numerose',
    colors: ['#ffffff', '#f1f8e9', '#dcedc8', '#c5e1a5', '#aed581', '#9ccc65', '#8bc34a', '#689f38'],
    unit: '%',
    format: (val) => `${val || 'N/D'}%`,
    jenksBreaks: [0, 0, 5, 12, 20, 30, 45, 65, 100],
    type: 'jenks'
},
femaleEmployment: {
    name: 'Tasso Occupazione Femminile',
    property: 'tasso di occupazione femminile',
    colors: ['#ffffff', '#fce4ec', '#f8bbd9', '#f48fb1', '#f06292', '#ec407a', '#e91e63', '#c2185b'],
    unit: '%',
    format: (val) => `${val || 'N/D'}%`,
    jenksBreaks: [0, 0, 20, 35, 45, 55, 70, 85, 100],
    type: 'jenks'
},

higherEducation: {
    name: 'Tasso Istruzione Superiore',
    property: 'tasso di istruzione superiore',
    colors: ['#ffffff', '#e8f5e8', '#c8e6c8', '#a5d6a5', '#82c782', '#5fb85f', '#3ca83c', '#1b5e20'],
    unit: '%',
    format: (val) => `${val || 'N/D'}%`,
    jenksBreaks: [0, 0, 15, 25, 35, 50, 65, 80, 100],
    type: 'jenks'
},
lowEducation: {
    name: 'Basso Tasso Istruzione',
    property: 'basso_tasso_di_istruzione',
    colors: ['#ffffff', '#ffebee', '#ffcdd2', '#ef9a9a', '#e57373', '#ef5350', '#f44336', '#d32f2f'],
    unit: '%',
    format: (val) => `${val || 'N/D'}%`,
    jenksBreaks: [0, 0, 10, 20, 35, 50, 65, 80, 100],
    type: 'jenks'
},
workIntegration: {
    name: 'Tasso Integrazione Lavoro',
    property: 'tasso di integrazione del lavoro',
    colors: ['#ffffff', '#e0f2f1', '#b2dfdb', '#80cbc4', '#4db6ac', '#26a69a', '#009688', '#00695c'],
    unit: '%',
    format: (val) => `${val || 'N/D'}%`,
    jenksBreaks: [0, 0, 20, 35, 50, 65, 75, 85, 100],
    type: 'jenks'
},
nonEuForeigners: {
    name: 'Tasso Stranieri Non-UE',
    property: 'tasso_stranieri_non_ue',
    colors: ['#ffffff', '#f3e5f5', '#e1bee7', '#ce93d8', '#ba68c8', '#ab47bc', '#9c27b0', '#7b1fa2'],
    unit: '%',
    format: (val) => `${val || 'N/D'}%`,
    jenksBreaks: [0, 0, 8, 18, 30, 45, 60, 80, 100],
    type: 'jenks'
},
youngForeigners: {
    name: 'Tasso Giovani Stranieri',
    property: 'tasso_giovani_stranieri',
    colors: ['#ffffff', '#fff8e1', '#ffecb3', '#ffe082', '#ffd54f', '#ffca28', '#ffc107', '#ffa000'],
    unit: '%',
    format: (val) => `${val || 'N/D'}%`,
    jenksBreaks: [0, 0, 12, 22, 35, 50, 65, 80, 100],
    type: 'jenks'
},		
            age: {
                name: 'Età Media',
                property: 'età_media',
                colors: ['#ffffff', '#ffe0b2', '#ffcc80', '#ffb74d', '#ffa726', '#ff9800', '#fb8c00', '#f57c00'],
                unit: 'anni',
                format: (val) => `${val || 'N/D'} anni`,
                jenksBreaks: [0, 0, 25, 35, 45, 55, 65, 75, 80], // Break points per range 0-80
                type: 'jenks'
            },
            elderly: {
                name: 'Tasso Anziani',
                property: 'tasso_anziani',
                colors: ['#f1f8e9', '#dcedc8', '#c5e1a5', '#aed581', '#9ccc65', '#8bc34a', '#7cb342', '#689f38'],
                unit: '%',
                format: (val) => `${val || 'N/D'}%`,
                jenksBreaks: [0, 5.2, 15.4, 25.1, 35.4, 44.7, 52.1, 58.8], // Break points ottimizzati per range 0-58.8%
                type: 'jenks'
            },
			density: {
				name: 'Densità Abitativa',
				property: 'densità abitativa',
				colors: ['#fce4ec', '#f8bbd9', '#f48fb1', '#f06292', '#ec407a', '#e91e63', '#d81b60', '#c2185b'],
				unit: 'ab/km²',
				format: (val) => `${val?.toLocaleString() || 'N/D'} ab/km²`,
				jenksBreaks: [0, 0, 1000, 3500, 7500, 15000, 30000, 60000, 194093], // Break points per range 0-194093
				type: 'jenks'
			},
			foreign: {
				name: 'Popolazione Straniera',
				property: 'tasso_di_popolazione_straniera',
				colors: ['#e0f2f1', '#b2dfdb', '#80cbc4', '#4db6ac', '#26a69a', '#009688', '#00897b', '#00695c'],
				unit: '%',
				format: (val) => `${val || 'N/D'}%`,
				jenksBreaks: [0, 0, 5, 12, 22, 35, 50, 70, 100], // Break points per range 0-100%
				type: 'jenks'
			},

employment: {
    name: 'Tasso Occupazione',
    property: 'tasso_di_occupazione',
    colors: ['#ffffff', '#f3e5f5', '#e1bee7', '#ce93d8', '#ba68c8', '#ab47bc', '#9c27b0', '#8e24aa'],
    unit: '%',
    format: (val) => `${val || 'N/D'}%`,
    jenksBreaks: [0, 0, 12, 25, 40, 55, 70, 85, 100],
    type: 'jenks'
},

genderGap: {
    name: 'Divario Genere Occupazione',
    property: 'divario di genere nell\'occupazione',
    colors: ['#4caf50', '#81c784', '#fff59d', '#ffcc02', '#ff9800', '#ff5722', '#d32f2f', '#b71c1c'],
    unit: '%',
    format: (val) => `${val || 'N/D'}%`,
    jenksBreaks: [-67, -30, -10, 0, 15, 30, 50, 75, 100],
    type: 'jenks'
},

resilience: {
    name: 'Resilienza Economica',
    property: 'resilienza_economica',
    colors: ['#ffffff', '#fff8e1', '#ffecb3', '#ffe082', '#ffd54f', '#ffca28', '#ffc107', '#ffa000'],
    unit: '%',
    format: (val) => `${val || 'N/D'}%`,
    jenksBreaks: [0, 0, 12.5, 25, 37.5, 50, 62.5, 75, 100],
    type: 'jenks'
},

cohesion: {
    name: 'Coesione Sociale',
    property: 'indice_coesione_sociale',
    colors: ['#ffffff', '#e1f5fe', '#b3e5fc', '#81d4fa', '#4fc3f7', '#29b6f6', '#03a9f4', '#0288d1'],
    unit: '%',
    format: (val) => `${val || 'N/D'}%`,
    jenksBreaks: [0, 0, 12, 24, 36, 48, 60, 72, 96.7],
    type: 'jenks'
},
surface_area: {
    name: 'Superficie Particella (m²)',
    property: 'superfice mq',
    colors: ['#ffffff', '#f0f4c3', '#dce775', '#cddc39', '#aed581', '#8bc34a', '#689f38', '#33691e'],
    unit: 'm²',
    format: (val) => `${val?.toLocaleString('it-IT', {maximumFractionDigits: 2}) || 'N/D'} m²`,
    jenksBreaks: [0, 9.77, 85, 180, 320, 580, 1200, 3500, 75549],
    type: 'jenks'
},

elevation_min: {
    name: 'Quota al suolo Min',
    property: 'elevation_min',
    colors: ['#ffffff', '#e8f5e8', '#c8e6c8', '#a5d6a5', '#82c782', '#5fb85f', '#3ca83c', '#1b5e20'],
    unit: 'm',
    format: (val) => `${val || 'N/D'} m`,
    jenksBreaks: [0, 0, 2, 5, 8, 12, 18, 25, 38.2],
    type: 'jenks'
},

elevation_max: {
    name: 'Quota al suolo Max',
    property: 'elevation_max',
    colors: ['#ffffff', '#e3f2fd', '#bbdefb', '#90caf9', '#64b5f6', '#42a5f5', '#2196f3', '#0d47a1'],
    unit: 'm',
    format: (val) => `${val || 'N/D'} m`,
    jenksBreaks: [0, 0, 3, 6, 10, 15, 20, 28, 38.7],
    type: 'jenks'
},

building_occupancy: {
    name: 'Occupazione Media Edificio',
    property: 'occupazione media dell\'edificio',
    colors: ['#ffffff', '#fff3e0', '#ffe0b2', '#ffcc80', '#ffb74d', '#ffa726', '#ff9800', '#e65100'],
    unit: '%',
    format: (val) => `${val || 'N/D'}%`,
    jenksBreaks: [0, 0, 2, 4, 7, 12, 18, 25, 33],
    type: 'jenks'
},

structural_dependency: {
    name: 'Indice Dipendenza Strutturale',
    property: 'indice_dipendenza_strutturale',
    colors: ['#ffffff', '#ffebee', '#ffcdd2', '#ef9a9a', '#e57373', '#ef5350', '#f44336', '#b71c1c'],
    unit: '%',
    format: (val) => `${val || 'N/D'}%`,
    jenksBreaks: [0, 0, 12, 25, 40, 58, 75, 88, 100],
    type: 'jenks'
},

robustness: {
    name: 'Indice di Robustezza',
    property: 'indice di robustezza',
    colors: ['#ffffff', '#f1f8e9', '#dcedc8', '#c5e1a5', '#aed581', '#9ccc65', '#8bc34a', '#33691e'],
    unit: '',
    format: (val) => `${val || 'N/D'}`,
    jenksBreaks: [0, 0, 0.15, 0.3, 0.45, 0.6, 0.8, 1.0, 1.2],
    type: 'jenks'
},

requalification_opportunity: {
    name: 'Opportunità di Riqualificazione',
    property: 'opport_riqualificazione',
    colors: ['#ffffff', '#f3e5f5', '#e1bee7', '#ce93d8', '#ba68c8', '#ab47bc', '#9c27b0', '#4a148c'],
    unit: '',
    format: (val) => `${val || 'N/D'}`,
    jenksBreaks: [0, 0, 0, 0, 0, 0, 0, 0, 0], // Tutti valori 0
    type: 'jenks'
},

real_estate_potential: {
    name: 'Potenziale Immobiliare',
    property: 'potenziale_immobiliare',
    colors: ['#ffffff', '#e0f2f1', '#b2dfdb', '#80cbc4', '#4db6ac', '#26a69a', '#009688', '#004d40'],
    unit: '%',
    format: (val) => `${val || 'N/D'}%`,
    jenksBreaks: [0, 0, 10, 20, 35, 50, 65, 75, 85],
    type: 'jenks'
},



            buildings: {
                name: 'Numero edifici per particella',
                property: 'buildings_count',
                colors: ['#ffffff', '#ffebee', '#ffcdd2', '#ef9a9a', '#e57373', '#ef5350', '#f44336', '#d32f2f'],
                unit: 'edifici',
                format: (val) => `${val || 'N/D'} edifici`,
                jenksBreaks: [0, 1, 2, 3, 4, 6, 9, 15, 23],
                type: 'jenks'
            },
            land_cover: {
                name: 'Copertura del suolo',
                property: 'copertura del suolo',
                colors: ['#FFFF64', '#228B22', '#90EE90', '#006400'],
                unit: '',
                format: (val) => landCoverLabels[val] || val || 'N/D',
                type: 'categorical'
            },
            flood_risk: {
                name: 'Rischio alluvione',
                property: 'rischio_alluvione',
                colors: ['#FF0000', '#C8C8C8'],
                unit: '',
                format: (val) => floodRiskLabels[val] || val || 'N/D',
                type: 'categorical'
            },
            landslide_risk: {
                name: 'Rischio di frana',
                property: 'rischio di frana',
                colors: ['#C8C8C8'],
                unit: '',
                format: (val) => landslideRiskLabels[val] || val || 'N/D',
                type: 'categorical'
            },
            coastal_erosion: {
                name: 'Rischio erosione costiera',
                property: 'rischio di erosione costiera',
                colors: ['#C8C8C8'],
                unit: '',
                format: (val) => coastalErosionLabels[val] || val || 'N/D',
                type: 'categorical'
            },
            seismic_risk: {
                name: 'Rischio sismico',
                property: 'rischio sismico',
                colors: ['#00FF00'],
                unit: '',
                format: (val) => seismicRiskLabels[val] || val || 'N/D',
                type: 'categorical'
            }
        };

        let currentTheme = 'landuse';
        let hoveredPolygon = null;
        let currentMandamentoFilter = null;
        let featuresData = [];

        // Caricamento mappa
        map.on('load', function() {
            // Aggiungi sorgente PMTiles
            map.addSource('palermo_catastale', {
                type: 'vector',
                url: 'pmtiles://https://palermohub.github.io/cspa/dati/pacs.pmtiles'
            });
            
            // Layer base - uso del suolo
            map.addLayer({
                id: 'catastale-base',
                type: 'fill',
                source: 'palermo_catastale',
                'source-layer': 'catastale',
                paint: {
                    'fill-color': [
                        'match',
                        ['get', 'class'],
                        'servizi', landUseColors.servizi,
                        'military', landUseColors.military,
                        'park', landUseColors.park,
                        'pedestrian', landUseColors.pedestrian,
                        'protected', landUseColors.protected,
                        'recreation', landUseColors.recreation,
                        'religious', landUseColors.religious,
                        'residential', landUseColors.residential,
                        'education', landUseColors.education,
                        'medical', landUseColors.medical,
                        'transportation', landUseColors.transportation,
                        landUseColors['']
                    ],
                    'fill-opacity': 0.75,
                    'fill-antialias': true
                }
            });

            // Layer hover
            map.addLayer({
                id: 'catastale-hover',
                type: 'fill',
                source: 'palermo_catastale',
                'source-layer': 'catastale',
                paint: {
                    'fill-color': '#ff9900',
                    'fill-opacity': 0.8
                },
                filter: ['==', ['get', 'fid'], '']
            });

            // Layer contorni - inizialmente nascosti
            map.addLayer({
                id: 'catastale-outline',
                type: 'line',
                source: 'palermo_catastale',
                'source-layer': 'catastale',
                paint: {
                    'line-color': '#333333',
                    'line-width': 0.5,
                    'line-opacity': 0.6
                },
                layout: {
                    'visibility': 'none'
                }
            });

            // LAYER PERIMETRI AGGIUNTIVI
            
            // Perimetro Palermo - tratteggio lungo (12px line, 8px gap)
            map.addLayer({
                id: 'palermo-perimeter',
                type: 'line',
                source: 'palermo_catastale',
                'source-layer': 'Palermo',
                paint: {
                    'line-color': '#ff0000',
                    'line-width': 2,
                    'line-opacity': 0.8,
                    'line-dasharray': [12, 8]
                },
                layout: {
                    'visibility': 'none'
                }
            }, 'catastale-hover');

            // Centro Storico - tratteggio medio (8px line, 6px gap)
            map.addLayer({
                id: 'centro-storico-perimeter',
                type: 'line',
                source: 'palermo_catastale',
                'source-layer': 'centro_storico',
                paint: {
                    'line-color': '#4a4a4a',
                    'line-width': 1.5,
                    'line-opacity': 0.8,
                    'line-dasharray': [8, 6]
                },
                layout: {
                    'visibility': 'none'
                }
            }, 'catastale-hover');

            // UPL Centro Storico - tratteggio corto (4px line, 4px gap)
            map.addLayer({
                id: 'upl-cs-perimeter',
                type: 'line',
                source: 'palermo_catastale',
                'source-layer': 'upl_cs',
                paint: {
                    'line-color': '#4a4a4a',
                    'line-width': 1,
                    'line-opacity': 0.8,
                    'line-dasharray': [4, 4]
                },
                layout: {
                    'visibility': 'visible'
                }
            }, 'catastale-hover');
            
            // Controlli navigazione
            map.addControl(new maplibregl.NavigationControl());
            
            // Imposta il valore di default per uso del suolo
            document.getElementById('territorial-select').value = 'landuse';
            
            // Event listener per caricamento dati (per calcoli dinamici)
            map.querySourceFeatures('palermo_catastale', {
                sourceLayer: 'catastale'
            });
            
            // Mostra legenda di base
            showBaseLegend();
        });

        // Gestione hover
        map.on('mouseenter', 'catastale-base', (e) => {
            map.getCanvas().style.cursor = 'pointer';
            
            if (e.features.length > 0) {
                const feature = e.features[0];
                const featureId = feature.properties.fid || feature.properties.particella || feature.id;
                
                if (hoveredPolygon !== null) {
                    map.setFilter('catastale-hover', ['==', ['get', 'fid'], '']);
                }
                
                hoveredPolygon = featureId;
                map.setFilter('catastale-hover', [
                    'any',
                    ['==', ['get', 'fid'], featureId],
                    ['==', ['get', 'particella'], featureId]
                ]);
            }
        });

        map.on('mouseleave', 'catastale-base', () => {
            map.getCanvas().style.cursor = '';
            
            if (hoveredPolygon !== null) {
                map.setFilter('catastale-hover', ['==', ['get', 'fid'], '']);
            }
            hoveredPolygon = null;
        });

        // Gestione click
        map.on('click', 'catastale-base', (e) => {
            if (e.features.length > 0) {
                const feature = e.features[0];
                showFeatureInfo(feature);
            }
        });

        // Funzioni controllo perimetri
        function togglePerimeter(layerId, show) {
            const visibility = show ? 'visible' : 'none';
            map.setLayoutProperty(layerId, 'visibility', visibility);
        }

        // Funzioni tematizzazione AGGIORNATE con Jenks-Fisher per popolazione, età, tasso anziani e buildings
        function applyTheme(themeKey) {
            const theme = themes[themeKey];
            if (!theme) return;

            if (map.getLayer('catastale-thematic')) {
                map.removeLayer('catastale-thematic');
            }

            const currentFilter = getCurrentFilter();

            let layerConfig = {
                id: 'catastale-thematic',
                type: 'fill',
                source: 'palermo_catastale',
                'source-layer': 'catastale',
                paint: {
                    'fill-opacity': 0.8
                }
            };

            // Configurazione specifica per temi con Jenks-Fisher
if (themeKey === 'buildings' || themeKey === 'population' || themeKey === 'age' || themeKey === 'elderly' || 
    themeKey === 'density' || themeKey === 'foreign' || themeKey === 'familySize' || themeKey === 'masculinity' || 
    themeKey === 'singlePerson' || themeKey === 'largeFamilies' || themeKey === 'femaleEmployment' || 
    themeKey === 'genderGap' || themeKey === 'higherEducation' || themeKey === 'lowEducation' || 
    themeKey === 'workIntegration' || themeKey === 'nonEuForeigners' || themeKey === 'youngForeigners' ||
    themeKey === 'resilience' || themeKey === 'cohesion' || themeKey === 'employment' ||
    themeKey === 'surface_area' || themeKey === 'elevation_min' || themeKey === 'elevation_max' ||
    themeKey === 'building_occupancy' || themeKey === 'structural_dependency' || themeKey === 'robustness' ||
    themeKey === 'requalification_opportunity' || themeKey === 'real_estate_potential') {
                const jenksBreaks = theme.jenksBreaks;
                if (themeKey === 'population') {
                    // Configurazione specifica per popolazione con 7 classi effettive
                    layerConfig.paint['fill-color'] = [
                        'step',
                        ['coalesce', ['get', theme.property], 0],
                        theme.colors[0], // 0 abitanti
                        jenksBreaks[2], theme.colors[1], // 1 abitante
                        jenksBreaks[3], theme.colors[2], // 2-5 abitanti
                        jenksBreaks[4], theme.colors[3], // 6-15 abitanti
                        jenksBreaks[5], theme.colors[4], // 16-35 abitanti
                        jenksBreaks[6], theme.colors[5], // 36-70 abitanti
                        jenksBreaks[7], theme.colors[6]  // 71-166 abitanti
                    ];
                } else if (themeKey === 'age') {
                    // Nuova configurazione per età media con 8 classi
                    layerConfig.paint['fill-color'] = [
                        'step',
                        ['coalesce', ['get', theme.property], 0],
                        theme.colors[0], // 0 anni (nessun dato)
                        jenksBreaks[2], theme.colors[1], // 1-24 anni
                        jenksBreaks[3], theme.colors[2], // 25-34 anni
                        jenksBreaks[4], theme.colors[3], // 35-44 anni
                        jenksBreaks[5], theme.colors[4], // 45-54 anni
                        jenksBreaks[6], theme.colors[5], // 55-64 anni
                        jenksBreaks[7], theme.colors[6], // 65-74 anni
                        jenksBreaks[8], theme.colors[7]  // 75-80 anni
                    ];
                } else if (themeKey === 'elderly') {
                    // Configurazione specifica per tasso anziani con 8 classi
                    layerConfig.paint['fill-color'] = [
                        'step',
                        ['coalesce', ['get', theme.property], 0],
                        theme.colors[0], // 0% (nessun dato)
                        jenksBreaks[1], theme.colors[1], // 0.1-5.2%
                        jenksBreaks[2], theme.colors[2], // 5.3-15.4%
                        jenksBreaks[3], theme.colors[3], // 15.5-25.1%
                        jenksBreaks[4], theme.colors[4], // 25.2-35.4%
                        jenksBreaks[5], theme.colors[5], // 35.5-44.7%
                        jenksBreaks[6], theme.colors[6], // 44.8-52.1%
                        jenksBreaks[7], theme.colors[7]  // 52.2-58.8%
                    ];
					
					} else if (themeKey === 'familySize') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0 componenti
        jenksBreaks[2], theme.colors[1], // 1-1.4
        jenksBreaks[3], theme.colors[2], // 1.5-2.1
        jenksBreaks[4], theme.colors[3], // 2.2-2.7
        jenksBreaks[5], theme.colors[4], // 2.8-3.4
        jenksBreaks[6], theme.colors[5], // 3.5-4.1
        jenksBreaks[7], theme.colors[6], // 4.2-4.9
        jenksBreaks[8], theme.colors[7]  // 5.0-33
    ];
} else if (themeKey === 'masculinity') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0%
        jenksBreaks[2], theme.colors[1], // 1-44%
        jenksBreaks[3], theme.colors[2], // 45-49%
        jenksBreaks[4], theme.colors[3], // 50-54%
        jenksBreaks[5], theme.colors[4], // 55-59%
        jenksBreaks[6], theme.colors[5], // 60-69%
        jenksBreaks[7], theme.colors[6], // 70-84%
        jenksBreaks[8], theme.colors[7]  // 85-100%
    ];
} else if (themeKey === 'singlePerson') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0%
        jenksBreaks[2], theme.colors[1], // 1-14%
        jenksBreaks[3], theme.colors[2], // 15-24%
        jenksBreaks[4], theme.colors[3], // 25-34%
        jenksBreaks[5], theme.colors[4], // 35-44%
        jenksBreaks[6], theme.colors[5], // 45-59%
        jenksBreaks[7], theme.colors[6], // 60-79%
        jenksBreaks[8], theme.colors[7]  // 80-100%
    ];
} else if (themeKey === 'largeFamilies') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0%
        jenksBreaks[2], theme.colors[1], // 1-4%
        jenksBreaks[3], theme.colors[2], // 5-11%
        jenksBreaks[4], theme.colors[3], // 12-19%
        jenksBreaks[5], theme.colors[4], // 20-29%
        jenksBreaks[6], theme.colors[5], // 30-44%
        jenksBreaks[7], theme.colors[6], // 45-64%
        jenksBreaks[8], theme.colors[7]  // 65-100%
    ];
} else if (themeKey === 'femaleEmployment') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0%
        jenksBreaks[2], theme.colors[1], // 1-19%
        jenksBreaks[3], theme.colors[2], // 20-34%
        jenksBreaks[4], theme.colors[3], // 35-44%
        jenksBreaks[5], theme.colors[4], // 45-54%
        jenksBreaks[6], theme.colors[5], // 55-69%
        jenksBreaks[7], theme.colors[6], // 70-84%
        jenksBreaks[8], theme.colors[7]  // 85-100%
    ];
} else if (themeKey === 'genderGap') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], -67],
        theme.colors[0], // -67 a -31%
        jenksBreaks[2], theme.colors[1], // -30 a -11%
        jenksBreaks[3], theme.colors[2], // -10 a -1%
        jenksBreaks[4], theme.colors[3], // 0 a 14%
        jenksBreaks[5], theme.colors[4], // 15 a 29%
        jenksBreaks[6], theme.colors[5], // 30 a 49%
        jenksBreaks[7], theme.colors[6], // 50 a 74%
        jenksBreaks[8], theme.colors[7]  // 75 a 100%
    ];
} else if (themeKey === 'higherEducation') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0%
        jenksBreaks[2], theme.colors[1], // 1-14%
        jenksBreaks[3], theme.colors[2], // 15-24%
        jenksBreaks[4], theme.colors[3], // 25-34%
        jenksBreaks[5], theme.colors[4], // 35-49%
        jenksBreaks[6], theme.colors[5], // 50-64%
        jenksBreaks[7], theme.colors[6], // 65-79%
        jenksBreaks[8], theme.colors[7]  // 80-100%
    ];
} else if (themeKey === 'lowEducation') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0%
        jenksBreaks[2], theme.colors[1], // 1-9%
        jenksBreaks[3], theme.colors[2], // 10-19%
        jenksBreaks[4], theme.colors[3], // 20-34%
        jenksBreaks[5], theme.colors[4], // 35-49%
        jenksBreaks[6], theme.colors[5], // 50-64%
        jenksBreaks[7], theme.colors[6], // 65-79%
        jenksBreaks[8], theme.colors[7]  // 80-100%
    ];
} else if (themeKey === 'workIntegration') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0%
        jenksBreaks[2], theme.colors[1], // 1-19%
        jenksBreaks[3], theme.colors[2], // 20-34%
        jenksBreaks[4], theme.colors[3], // 35-49%
        jenksBreaks[5], theme.colors[4], // 50-64%
        jenksBreaks[6], theme.colors[5], // 65-74%
        jenksBreaks[7], theme.colors[6], // 75-84%
        jenksBreaks[8], theme.colors[7]  // 85-100%
    ];
} else if (themeKey === 'nonEuForeigners') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0%
        jenksBreaks[2], theme.colors[1], // 1-7%
        jenksBreaks[3], theme.colors[2], // 8-17%
        jenksBreaks[4], theme.colors[3], // 18-29%
        jenksBreaks[5], theme.colors[4], // 30-44%
        jenksBreaks[6], theme.colors[5], // 45-59%
        jenksBreaks[7], theme.colors[6], // 60-79%
        jenksBreaks[8], theme.colors[7]  // 80-100%
    ];
} else if (themeKey === 'youngForeigners') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0%
        jenksBreaks[2], theme.colors[1], // 1-11%
        jenksBreaks[3], theme.colors[2], // 12-21%
        jenksBreaks[4], theme.colors[3], // 22-34%
        jenksBreaks[5], theme.colors[4], // 35-49%
        jenksBreaks[6], theme.colors[5], // 50-64%
        jenksBreaks[7], theme.colors[6], // 65-79%
        jenksBreaks[8], theme.colors[7]  // 80-100%
    ];
					
					
					
										} else if (themeKey === 'density') {
						// Configurazione specifica per densità abitativa con 8 classi
						layerConfig.paint['fill-color'] = [
							'step',
							['coalesce', ['get', theme.property], 0],
							theme.colors[0], // 0 ab/km² (nessun dato)
							jenksBreaks[2], theme.colors[1], // 1-999 ab/km²
							jenksBreaks[3], theme.colors[2], // 1000-3499 ab/km²
							jenksBreaks[4], theme.colors[3], // 3500-7499 ab/km²
							jenksBreaks[5], theme.colors[4], // 7500-14999 ab/km²
							jenksBreaks[6], theme.colors[5], // 15000-29999 ab/km²
							jenksBreaks[7], theme.colors[6], // 30000-59999 ab/km²
							jenksBreaks[8], theme.colors[7]  // 60000-194093 ab/km²
						];
					} else if (themeKey === 'foreign') {
						// Configurazione specifica per popolazione straniera con 8 classi
						layerConfig.paint['fill-color'] = [
							'step',
							['coalesce', ['get', theme.property], 0],
							theme.colors[0], // 0% (nessun dato)
							jenksBreaks[2], theme.colors[1], // 1-4%
							jenksBreaks[3], theme.colors[2], // 5-11%
							jenksBreaks[4], theme.colors[3], // 12-21%
							jenksBreaks[5], theme.colors[4], // 22-34%
							jenksBreaks[6], theme.colors[5], // 35-49%
							jenksBreaks[7], theme.colors[6], // 50-69%
							jenksBreaks[8], theme.colors[7]  // 70-100%
						];
						
						} else if (themeKey === 'resilience') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0%
        jenksBreaks[2], theme.colors[1], // 1-12.5%
        jenksBreaks[3], theme.colors[2], // 12.6-25%
        jenksBreaks[4], theme.colors[3], // 25.1-37.5%
        jenksBreaks[5], theme.colors[4], // 37.6-50%
        jenksBreaks[6], theme.colors[5], // 50.1-62.5%
        jenksBreaks[7], theme.colors[6], // 62.6-75%
        jenksBreaks[8], theme.colors[7]  // 75.1-100%
    ];
} else if (themeKey === 'cohesion') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0%
        jenksBreaks[2], theme.colors[1], // 1-12%
        jenksBreaks[3], theme.colors[2], // 12.1-24%
        jenksBreaks[4], theme.colors[3], // 24.1-36%
        jenksBreaks[5], theme.colors[4], // 36.1-48%
        jenksBreaks[6], theme.colors[5], // 48.1-60%
        jenksBreaks[7], theme.colors[6], // 60.1-72%
        jenksBreaks[8], theme.colors[7]  // 72.1-96.7%
    ];
	
	} else if (themeKey === 'surface_area') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0 m²
        jenksBreaks[2], theme.colors[1], // 9.77-84 m²
        jenksBreaks[3], theme.colors[2], // 85-179 m²
        jenksBreaks[4], theme.colors[3], // 180-319 m²
        jenksBreaks[5], theme.colors[4], // 320-579 m²
        jenksBreaks[6], theme.colors[5], // 580-1199 m²
        jenksBreaks[7], theme.colors[6], // 1200-3499 m²
        jenksBreaks[8], theme.colors[7]  // 3500-75549 m²
    ];
} else if (themeKey === 'elevation_min') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0 m
        jenksBreaks[2], theme.colors[1], // 0-1 m
        jenksBreaks[3], theme.colors[2], // 2-4 m
        jenksBreaks[4], theme.colors[3], // 5-7 m
        jenksBreaks[5], theme.colors[4], // 8-11 m
        jenksBreaks[6], theme.colors[5], // 12-17 m
        jenksBreaks[7], theme.colors[6], // 18-24 m
        jenksBreaks[8], theme.colors[7]  // 25-38.2 m
    ];
} else if (themeKey === 'elevation_max') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0 m
        jenksBreaks[2], theme.colors[1], // 0-2 m
        jenksBreaks[3], theme.colors[2], // 3-5 m
        jenksBreaks[4], theme.colors[3], // 6-9 m
        jenksBreaks[5], theme.colors[4], // 10-14 m
        jenksBreaks[6], theme.colors[5], // 15-19 m
        jenksBreaks[7], theme.colors[6], // 20-27 m
        jenksBreaks[8], theme.colors[7]  // 28-38.7 m
    ];
} else if (themeKey === 'building_occupancy') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0%
        jenksBreaks[2], theme.colors[1], // 0-1%
        jenksBreaks[3], theme.colors[2], // 2-3%
        jenksBreaks[4], theme.colors[3], // 4-6%
        jenksBreaks[5], theme.colors[4], // 7-11%
        jenksBreaks[6], theme.colors[5], // 12-17%
        jenksBreaks[7], theme.colors[6], // 18-24%
        jenksBreaks[8], theme.colors[7]  // 25-33%
    ];
} else if (themeKey === 'structural_dependency') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0%
        jenksBreaks[2], theme.colors[1], // 0-11%
        jenksBreaks[3], theme.colors[2], // 12-24%
        jenksBreaks[4], theme.colors[3], // 25-39%
        jenksBreaks[5], theme.colors[4], // 40-57%
        jenksBreaks[6], theme.colors[5], // 58-74%
        jenksBreaks[7], theme.colors[6], // 75-87%
        jenksBreaks[8], theme.colors[7]  // 88-100%
    ];
} else if (themeKey === 'robustness') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0
        jenksBreaks[2], theme.colors[1], // 0-0.14
        jenksBreaks[3], theme.colors[2], // 0.15-0.29
        jenksBreaks[4], theme.colors[3], // 0.3-0.44
        jenksBreaks[5], theme.colors[4], // 0.45-0.59
        jenksBreaks[6], theme.colors[5], // 0.6-0.79
        jenksBreaks[7], theme.colors[6], // 0.8-0.99
        jenksBreaks[8], theme.colors[7]  // 1.0-1.2
    ];
} else if (themeKey === 'requalification_opportunity') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // Tutti 0 - colore uniforme
        1, theme.colors[0] // Mantiene colore uniforme
    ];
} else if (themeKey === 'real_estate_potential') {
    layerConfig.paint['fill-color'] = [
        'step',
        ['coalesce', ['get', theme.property], 0],
        theme.colors[0], // 0%
        jenksBreaks[2], theme.colors[1], // 0-9%
        jenksBreaks[3], theme.colors[2], // 10-19%
        jenksBreaks[4], theme.colors[3], // 20-34%
        jenksBreaks[5], theme.colors[4], // 35-49%
        jenksBreaks[6], theme.colors[5], // 50-64%
        jenksBreaks[7], theme.colors[6], // 65-74%
        jenksBreaks[8], theme.colors[7]  // 75-85%
    ];
						
					
                } else {
                    // Configurazione per buildings (codice esistente)
                    layerConfig.paint['fill-color'] = [
                        'step',
                        ['coalesce', ['get', theme.property], 0],
                        theme.colors[0], // 0 edifici
                        jenksBreaks[1], theme.colors[1], // 1 edificio
                        jenksBreaks[2], theme.colors[2], // 2 edifici
                        jenksBreaks[3], theme.colors[3], // 3 edifici
                        jenksBreaks[4], theme.colors[4], // 4 edifici
                        jenksBreaks[5], theme.colors[5], // 6 edifici
                        jenksBreaks[6], theme.colors[6], // 9 edifici
                        jenksBreaks[7], theme.colors[7]  // 15+ edifici
                    ];
                }
            }
            // Configurazione specifica per land_cover
            else if (themeKey === 'land_cover') {
                layerConfig.paint['fill-color'] = [
                    'match',
                    ['get', 'copertura del suolo'],
                    '1110', landCoverColors['1110'],
                    '2111', landCoverColors['2111'],
                    '2112', landCoverColors['2112'],
                    '2212', landCoverColors['2212'],
                    'rgba(200,200,200,0.5)' // Default per valori non classificati
                ];
            } 
           else if (themeKey === 'flood_risk') {
            // CORREZIONE: Gestione robusta per rischio alluvione con normalizzazione dei valori
            layerConfig.paint['fill-color'] = [
                'match',
                ['downcase', ['coalesce', ['get', 'rischio_alluvione'], '']],
                'high', floodRiskColors['high'],
                'none', floodRiskColors['none'],
                floodRiskColors['none']  // Default per valori non riconosciuti
                ];
            } 
            else if (themeKey === 'landslide_risk') {
                layerConfig.paint['fill-color'] = [
                    'case',
                    [
                        'any',
                        ['==', ['downcase', ['to-string', ['get', 'rischio di frana']]], 'none'],
                        ['==', ['get', 'rischio di frana'], 'none'],
                        ['==', ['get', 'rischio di frana'], null],
                        ['==', ['get', 'rischio di frana'], '']
                    ],
                    landslideRiskColors['none'],
                    'rgba(200,200,200,0.5)' // Default
                ];
            } 
            else if (themeKey === 'coastal_erosion') {
                layerConfig.paint['fill-color'] = [
                    'case',
                    [
                        'any',
                        ['==', ['downcase', ['to-string', ['get', 'rischio di erosione costiera']]], 'none'],
                        ['==', ['get', 'rischio di erosione costiera'], 'none'],
                        ['==', ['get', 'rischio di erosione costiera'], null],
                        ['==', ['get', 'rischio di erosione costiera'], '']
                    ],
                    coastalErosionColors['none'],
                    'rgba(200,200,200,0.5)' // Default
                ];
            } 
            else if (themeKey === 'seismic_risk') {
                layerConfig.paint['fill-color'] = [
                    'case',
                    [
                        'any',
                        ['==', ['downcase', ['to-string', ['get', 'rischio sismico']]], 'low'],
                        ['==', ['get', 'rischio sismico'], 'low'],
                        ['==', ['get', 'rischio sismico'], 'LOW']
                    ],
                    seismicRiskColors['low'],
                    'rgba(200,200,200,0.5)' // Default
                ];
            } 
            else {
                // Configurazione standard per temi numerici (usa calcolo dinamico)
                let range = null;
                if (theme.type !== 'categorical') {
                    const dynamicRange = calculateDynamicRange(themeKey);
                    range = dynamicRange || getStaticRange(themeKey);
                }
                
                const step = (range.max - range.min) / (theme.colors.length - 1);
                layerConfig.paint['fill-color'] = [
                    'interpolate',
                    ['linear'],
                    ['coalesce', ['get', theme.property], range.min],
                    range.min, theme.colors[0],
                    range.min + step, theme.colors[1],
                    range.min + (step * 2), theme.colors[2],
                    range.min + (step * 3), theme.colors[3],
                    range.min + (step * 4), theme.colors[4],
                    range.min + (step * 5), theme.colors[5],
                    range.min + (step * 6), theme.colors[6],
                    range.max, theme.colors[7]
                ];
            }

            if (currentFilter) {
                layerConfig.filter = currentFilter;
            }

            map.addLayer(layerConfig, 'catastale-outline');
            map.setPaintProperty('catastale-base', 'fill-opacity', 0);
            
            currentTheme = themeKey;
            
            // Mostra legenda appropriata
if (themeKey === 'buildings' || themeKey === 'population' || themeKey === 'age' || themeKey === 'elderly' || 
    themeKey === 'density' || themeKey === 'foreign' || themeKey === 'familySize' || themeKey === 'masculinity' || 
    themeKey === 'singlePerson' || themeKey === 'largeFamilies' || themeKey === 'femaleEmployment' || 
    themeKey === 'genderGap' || themeKey === 'higherEducation' || themeKey === 'lowEducation' || 
    themeKey === 'workIntegration' || themeKey === 'nonEuForeigners' || themeKey === 'youngForeigners' ||
    themeKey === 'resilience' || themeKey === 'cohesion' || themeKey === 'employment' ||
    themeKey === 'surface_area' || themeKey === 'elevation_min' || themeKey === 'elevation_max' ||
    themeKey === 'building_occupancy' || themeKey === 'structural_dependency' || themeKey === 'robustness' ||
    themeKey === 'requalification_opportunity' || themeKey === 'real_estate_potential') {
                showJenksLegend(theme);
            } else {
                const range = calculateDynamicRange(themeKey) || getStaticRange(themeKey);
                showLegend(theme, range);
            }
        }

        function calculateDynamicRange(themeKey) {
            // Simula il calcolo del range dai dati filtrati
            if (!currentMandamentoFilter) return null;
            
            const theme = themes[themeKey];
            if (!theme) return null;
            
            // Range ridotti per simulare l'effetto del filtro
            const filteredRanges = {
                employment: { min: 0, max: 90 },
                genderGap: { min: 0, max: 80 },
                education: { min: 0, max: 90 },
                resilience: { min: 0, max: 90 },
                cohesion: { min: 0, max: 90 }
            };
            
            return filteredRanges[themeKey];
        }

        function getStaticRange(themeKey) {
            // Range valori - tutti iniziano da 0
            const valueRanges = {
                employment: { min: 0, max: 100 },
                genderGap: { min: 0, max: 100 },
                education: { min: 0, max: 100 },
                resilience: { min: 0, max: 100 },
                cohesion: { min: 0, max: 100 }
            };
            
            return valueRanges[themeKey];
        }

        function getCurrentFilter() {
            if (currentMandamentoFilter && currentMandamentoFilter !== '') {
                // Mappa il nome dell'interfaccia al nome del database
                let dbMandamento = currentMandamentoFilter;
                if (currentMandamentoFilter === 'Castellammare') {
                    dbMandamento = 'Castellamare';
                }
                return ['==', ['get', 'Mandamento'], dbMandamento];
            }
            return null;
        }

        function applyMandamentoFilter(mandamento) {
            // Salva l'indicatore corrente
            const activeTheme = currentTheme;
            
            // Aggiorna il filtro corrente
            currentMandamentoFilter = mandamento || null;
            
            // Mappa il nome dell'interfaccia al nome del database
            let dbMandamento = mandamento;
            if (mandamento === 'Castellammare') {
                dbMandamento = 'Castellamare';
            }
            
            const filter = dbMandamento ? ['==', ['get', 'Mandamento'], dbMandamento] : null;
            
            // Applica filtro ai layer base
            map.setFilter('catastale-base', filter);
            map.setFilter('catastale-hover', ['==', ['get', 'fid'], '']); // Reset hover
            map.setFilter('catastale-outline', filter);
            
            // Se c'è un indicatore attivo (non uso del suolo), riapplicalo
            if (activeTheme && activeTheme !== 'landuse') {
                applyTheme(activeTheme);
            } else {
                // Altrimenti assicurati che il layer base sia visibile
                if (map.getLayer('catastale-thematic')) {
                    map.removeLayer('catastale-thematic');
                }
                map.setPaintProperty('catastale-base', 'fill-opacity', 0.75);
                showBaseLegend();
            }
        }

        function toggleBorders(show) {
            const visibility = show ? 'visible' : 'none';
            map.setLayoutProperty('catastale-outline', 'visibility', visibility);
        }

function removeTheme() {
    if (map.getLayer('catastale-thematic')) {
        map.removeLayer('catastale-thematic');
    }
    
    // Ripristina layer base con opacità corretta
    map.setPaintProperty('catastale-base', 'fill-opacity', 0.75);
    
    // Applica il filtro mandamento corrente al layer base
    const filter = getCurrentFilter();
    map.setFilter('catastale-base', filter);
    
    currentTheme = 'landuse';
    showBaseLegend();
}

        // Funzione per mostrare legenda Jenks-Fisher per buildings, popolazione, età e tasso anziani
        function showJenksLegend(theme) {
            const legend = document.getElementById('legend');
            const title = document.getElementById('legend-title');
            const items = document.getElementById('legend-items');
            
            let titleText = theme.name + ' (Jenks-Fisher)';
            if (currentMandamentoFilter) {
                titleText += ` - ${currentMandamentoFilter}`;
            }
            title.textContent = titleText;
            
            items.innerHTML = '';
            
            let labels = [];
            
            if (currentTheme === 'population') {
                labels = [
                    '0 abitanti',
                    '1 abitante', 
                    '2-3 abitanti',
                    '4-6 abitanti', 
                    '7-12 abitanti',
                    '13-20 abitanti',
                    '21-35 abitanti'
                ];
            } else if (currentTheme === 'age') {
                labels = [
                    '0 anni (nessun dato)',
                    '1-24 anni',
                    '25-34 anni', 
                    '35-44 anni',
                    '45-54 anni',
                    '55-64 anni',
                    '65-74 anni',
                    '75-80 anni'
                ];
				
				
				
            } else if (currentTheme === 'elderly') {
                labels = [
                    '0% (nessun dato)',
                    '0.1-5.2%',
                    '5.3-15.4%', 
                    '15.5-25.1%',
                    '25.2-35.4%',
                    '35.5-44.7%',
                    '44.8-52.1%',
                    '52.2-58.8%'
                ];
				
				} else if (currentTheme === 'familySize') {
    labels = [
        '0 componenti (nessun dato)',
        '1-1.4 componenti',
        '1.5-2.1 componenti',
        '2.2-2.7 componenti',
        '2.8-3.4 componenti',
        '3.5-4.1 componenti',
        '4.2-4.9 componenti',
        '5.0-33 componenti'
    ];
} else if (currentTheme === 'masculinity') {
    labels = [
        '0% (nessun dato)',
        '1-44%',
        '45-49%',
        '50-54%',
        '55-59%',
        '60-69%',
        '70-84%',
        '85-100%'
    ];
} else if (currentTheme === 'singlePerson') {
    labels = [
        '0% (nessun dato)',
        '1-14%',
        '15-24%',
        '25-34%',
        '35-44%',
        '45-59%',
        '60-79%',
        '80-100%'
    ];
	} else if (currentTheme === 'employment') {
    labels = [
        '0% (nessun dato)',
        '1-12%',
        '13-25%',
        '26-40%',
        '41-55%',
        '56-70%',
        '71-85%',
        '86-100%'
    ];
} else if (currentTheme === 'largeFamilies') {
    labels = [
        '0% (nessun dato)',
        '1-4%',
        '5-11%',
        '12-19%',
        '20-29%',
        '30-44%',
        '45-64%',
        '65-100%'
    ];
} else if (currentTheme === 'femaleEmployment') {
    labels = [
        '0% (nessun dato)',
        '1-19%',
        '20-34%',
        '35-44%',
        '45-54%',
        '55-69%',
        '70-84%',
        '85-100%'
    ];
} else if (currentTheme === 'genderGap') {
    labels = [
        '-67% a -31% (Favorevole donne)',
        '-30% a -11% (Lievemente favorevole donne)',
        '-10% a -1% (Quasi paritario - donne)',
        '0% a 14% (Quasi paritario - uomini)',
        '15% a 29% (Lievemente favorevole uomini)',
        '30% a 49% (Favorevole uomini)',
        '50% a 74% (Molto favorevole uomini)',
        '75% a 100% (Estremamente favorevole uomini)'
    ];
} else if (currentTheme === 'higherEducation') {
    labels = [
        '0% (nessun dato)',
        '1-14%',
        '15-24%',
        '25-34%',
        '35-49%',
        '50-64%',
        '65-79%',
        '80-100%'
    ];
} else if (currentTheme === 'lowEducation') {
    labels = [
        '0% (nessun dato)',
        '1-9%',
        '10-19%',
        '20-34%',
        '35-49%',
        '50-64%',
        '65-79%',
        '80-100%'
    ];
} else if (currentTheme === 'workIntegration') {
    labels = [
        '0% (nessun dato)',
        '1-19%',
        '20-34%',
        '35-49%',
        '50-64%',
        '65-74%',
        '75-84%',
        '85-100%'
    ];
} else if (currentTheme === 'nonEuForeigners') {
    labels = [
        '0% (nessun dato)',
        '1-7%',
        '8-17%',
        '18-29%',
        '30-44%',
        '45-59%',
        '60-79%',
        '80-100%'
    ];
} else if (currentTheme === 'youngForeigners') {
    labels = [
        '0% (nessun dato)',
        '1-11%',
        '12-21%',
        '22-34%',
        '35-49%',
        '50-64%',
        '65-79%',
        '80-100%'
    ];			
            } else if (currentTheme === 'buildings') {
                labels = [
                    '0 edifici',
                    '1 edificio', 
                    '2 edifici',
                    '3 edifici',
                    '4-5 edifici',
                    '6-8 edifici',
                    '9-14 edifici',
                    '15-23 edifici'
                ];
				
				} else if (currentTheme === 'resilience') {
    labels = [
        '0% (nessun dato)',
        '1-12.5%',
        '12.6-25%',
        '25.1-37.5%',
        '37.6-50%',
        '50.1-62.5%',
        '62.6-75%',
        '75.1-100%'
    ];
} else if (currentTheme === 'cohesion') {
    labels = [
        '0% (nessun dato)',
        '1-12%',
        '12.1-24%',
        '24.1-36%',
        '36.1-48%',
        '48.1-60%',
        '60.1-72%',
        '72.1-96.7%'
    ];
	} else if (currentTheme === 'surface_area') {
    labels = [
        '0 m² (nessun dato)',
        '9.77-84 m²',
        '85-179 m²',
        '180-319 m²',
        '320-579 m²',
        '580-1.199 m²',
        '1.200-3.499 m²',
        '3.500-75.549 m²'
    ];
} else if (currentTheme === 'elevation_min') {
    labels = [
        '0 m (nessun dato)',
        '0-1 m',
        '2-4 m',
        '5-7 m',
        '8-11 m',
        '12-17 m',
        '18-24 m',
        '25-38.2 m'
    ];
} else if (currentTheme === 'elevation_max') {
    labels = [
        '0 m (nessun dato)',
        '0-2 m',
        '3-5 m',
        '6-9 m',
        '10-14 m',
        '15-19 m',
        '20-27 m',
        '28-38.7 m'
    ];
} else if (currentTheme === 'building_occupancy') {
    labels = [
        '0% (nessun dato)',
        '0-1%',
        '2-3%',
        '4-6%',
        '7-11%',
        '12-17%',
        '18-24%',
        '25-33%'
    ];
} else if (currentTheme === 'structural_dependency') {
    labels = [
        '0% (nessun dato)',
        '0-11%',
        '12-24%',
        '25-39%',
        '40-57%',
        '58-74%',
        '75-87%',
        '88-100%'
    ];
} else if (currentTheme === 'robustness') {
    labels = [
        '0 (nessun dato)',
        '0-0.14',
        '0.15-0.29',
        '0.3-0.44',
        '0.45-0.59',
        '0.6-0.79',
        '0.8-0.99',
        '1.0-1.2'
    ];
} else if (currentTheme === 'requalification_opportunity') {
    labels = [
        'Tutti i valori = 0',
        '', '', '', '', '', '', '' // Classi vuote
    ];
} else if (currentTheme === 'real_estate_potential') {
    labels = [
        '0% (nessun dato)',
        '0-9%',
        '10-19%',
        '20-34%',
        '35-49%',
        '50-64%',
        '65-74%',
        '75-85%'
    ];
				
			} else if (currentTheme === 'density') {
				labels = [
					'0 ab/km² (nessun dato)',
					'1-999 ab/km²',
					'1.000-3.499 ab/km²', 
					'3.500-7.499 ab/km²',
					'7.500-14.999 ab/km²',
					'15.000-29.999 ab/km²',
					'30.000-59.999 ab/km²',
					'60.000-194.093 ab/km²'
				];
			} else if (currentTheme === 'foreign') {
				labels = [
					'0% (nessun dato)',
					'1-4%',
					'5-11%', 
					'12-21%',
					'22-34%',
					'35-49%',
					'50-69%',
					'70-100%'
				];	
				
            }
            
            // Usa solo le prime 7 classi per popolazione, tutte le 8 per età, tasso anziani e buildings
          const numClasses = currentTheme === 'population' ? 7 : 8;
            
            for (let i = 0; i < numClasses; i++) {
                const item = document.createElement('div');
                item.className = 'legend-item';
                
                item.innerHTML = `
                    <div class="legend-color" style="background-color: ${theme.colors[i]}"></div>
                    <span class="legend-label">${labels[i]}</span>
                `;
                items.appendChild(item);
            }
            
            legend.classList.add('visible');
        }

        // Funzione showLegend aggiornata per gestire temi categorici
        function showLegend(theme, range) {
            const legend = document.getElementById('legend');
            const title = document.getElementById('legend-title');
            const items = document.getElementById('legend-items');
            
            let titleText = theme.name;
            if (currentMandamentoFilter) {
                titleText += ` - ${currentMandamentoFilter}`;
            }
            title.textContent = titleText;
            
            items.innerHTML = '';
            
            // Gestione legenda per temi categorici
            if (theme.type === 'categorical') {
                let colorMap = {};
                let labelMap = {};
                
                switch (currentTheme) {
                    case 'land_cover':
                        colorMap = landCoverColors;
                        labelMap = landCoverLabels;
                        break;
                    case 'flood_risk':
                        colorMap = floodRiskColors;
                        labelMap = floodRiskLabels;
                        break;
                    case 'landslide_risk':
                        colorMap = landslideRiskColors;
                        labelMap = landslideRiskLabels;
                        break;
                    case 'coastal_erosion':
                        colorMap = coastalErosionColors;
                        labelMap = coastalErosionLabels;
                        break;
                    case 'seismic_risk':
                        colorMap = seismicRiskColors;
                        labelMap = seismicRiskLabels;
                        break;
                }
                
                for (const [code, color] of Object.entries(colorMap)) {
                    const label = labelMap[code] || code;
                    
                    const item = document.createElement('div');
                    item.className = 'legend-item';
                    item.innerHTML = `
                        <div class="legend-color" style="background-color: ${color}"></div>
                        <span class="legend-label">${label}</span>
                    `;
                    items.appendChild(item);
                }
            } 
            else {
                // Gestione standard per temi numerici
                const step = (range.max - range.min) / (theme.colors.length - 1);
                
                theme.colors.forEach((color, i) => {
                    const minVal = Math.round(range.min + (step * i));
                    const maxVal = i === theme.colors.length - 1 ? 
                        range.max : 
                        Math.round(range.min + (step * (i + 1)));
                    
                    const item = document.createElement('div');
                    item.className = 'legend-item';
                    
                    let label = `${minVal} - ${maxVal} ${theme.unit}`;
                    
                    item.innerHTML = `
                        <div class="legend-color" style="background-color: ${color}"></div>
                        <span class="legend-label">${label}</span>
                    `;
                    items.appendChild(item);
                });
            }
            
            legend.classList.add('visible');
        }

        function showBaseLegend() {
            const legend = document.getElementById('legend');
            const title = document.getElementById('legend-title');
            const items = document.getElementById('legend-items');
            
            let titleText = 'Base catastale';
            if (currentMandamentoFilter) {
                titleText += ` - ${currentMandamentoFilter}`;
            }
            title.textContent = titleText;
            
            items.innerHTML = '';
            
            for (const [className, color] of Object.entries(landUseColors)) {
                const label = landUseLabels[className];
                
                const item = document.createElement('div');
                item.className = 'legend-item';
                
                item.innerHTML = `
                    <div class="legend-color" style="background-color: ${color}"></div>
                    <span class="legend-label">${label}</span>
                `;
                items.appendChild(item);
            }
            
            legend.classList.add('visible');
        }

        // Pannello informazioni
        function showFeatureInfo(feature) {
            const panel = document.getElementById('info-panel');
            const title = document.getElementById('panel-title');
            const subtitle = document.getElementById('panel-subtitle');
            const content = document.getElementById('info-content');
            
            const props = feature.properties;
            
            // Correggi il nome del mandamento se necessario
            let mandamentoDisplay = props.Mandamento || 'N/D';
            if (mandamentoDisplay === 'Castellamare') {
                mandamentoDisplay = 'Castellammare';
            }
            
            title.textContent = `Particella ${props.particella || props.fid || 'N/D'}`;
            subtitle.textContent = `Foglio: ${props.foglio || 'N/D'}`;
            
            content.innerHTML = `
                <div class="info-group">
                    <h3><i class="fas fa-map-marker-alt"></i> Informazioni Generali</h3>
                    <div class="info-item">
                     <span class="info-label">Circoscrizione:</span>
                        <span class="info-value">I°</span>
                    </div>
					                    <div class="info-item">
                     <span class="info-label">Mandamento:</span>
                        <span class="info-value">${mandamentoDisplay}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Superficie (m²):</span>
                        <span class="info-value">${props['superfice mq'] ? parseFloat(props['superfice mq']).toLocaleString('it-IT', {maximumFractionDigits: 2}) + ' m²' : 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Classe:</span>
                        <span class="info-value">${landUseLabels[props.class] || props.class || 'N/D'}</span>
                    </div>
					<div class="info-item">
                        <span class="info-label">Sottoclasse:</span>
                        <span class="info-value">${landUseLabels[props.subtype] || props.subtype || 'N/D'}</span>
                    </div>
                </div>

                <div class="info-group">
                    <h3><i class="fas fa-users"></i> Demografia</h3>
                    <div class="info-item">
                        <span class="info-label">Popolazione Stimata:</span>
                        <span class="info-value">${props.popolazione_stimata ? parseFloat(props.popolazione_stimata).toLocaleString('it-IT', {maximumFractionDigits: 2}) : 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Età Media:</span>
                        <span class="info-value">${props['età_media'] ? parseFloat(props['età_media']).toFixed(2) + ' anni' : 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Tasso Anziani:</span>
                        <span class="info-value">${props.tasso_anziani ? parseFloat(props.tasso_anziani).toFixed(2) + '%' : 'N/D'}</span>
                    </div>
    <div class="info-item">
        <span class="info-label">Dimensione Media Famiglia:</span>
        <span class="info-value">${props['dimensione media della famiglia'] ? parseFloat(props['dimensione media della famiglia']).toFixed(2) + ' componenti' : 'N/D'}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Tasso di Mascolinità:</span>
        <span class="info-value">${props['tasso di mascolinità'] ? parseFloat(props['tasso di mascolinità']).toFixed(2) + '%' : 'N/D'}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Tasso Persona Singola:</span>
        <span class="info-value">${props['tasso_persona singola'] ? parseFloat(props['tasso_persona singola']).toFixed(2) + '%' : 'N/D'}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Tasso Famiglie Numerose:</span>
        <span class="info-value">${props.tasso_famiglie_numerose ? parseFloat(props.tasso_famiglie_numerose).toFixed(2) + '%' : 'N/D'}</span>
    </div>
	<div class="info-item">
                        <span class="info-label">Popolazione Straniera:</span>
                        <span class="info-value">${props.tasso_di_popolazione_straniera ? parseFloat(props.tasso_di_popolazione_straniera).toFixed(2) + '%' : 'N/D'}</span>
                    </div>
					    <div class="info-item">
        <span class="info-label">Stranieri Non-UE:</span>
        <span class="info-value">${props.tasso_stranieri_non_ue ? parseFloat(props.tasso_stranieri_non_ue).toFixed(2) + '%' : 'N/D'}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Giovani Stranieri:</span>
        <span class="info-value">${props.tasso_giovani_stranieri ? parseFloat(props.tasso_giovani_stranieri).toFixed(2) + '%' : 'N/D'}</span>
    </div>
</div>
									
                </div>
                <div class="info-group">
                    <h3><i class="fas fa-briefcase"></i> Socio-Economici</h3>
                    <div class="info-item">
                        <span class="info-label">Tasso Occupazione:</span>
                        <span class="info-value">${props.tasso_di_occupazione ? parseFloat(props.tasso_di_occupazione).toFixed(2) + '%' : 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Occup. Femminile:</span>
                        <span class="info-value">${props['tasso di occupazione femminile'] ? parseFloat(props['tasso di occupazione femminile']).toFixed(2) + '%' : 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Divario Genere:</span>
                        <span class="info-value">${props['divario di genere nell\'occupazione'] ? parseFloat(props['divario di genere nell\'occupazione']).toFixed(2) + '%' : 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Istruzione Superiore:</span>
                        <span class="info-value">${props['tasso di istruzione superiore'] ? parseFloat(props['tasso di istruzione superiore']).toFixed(2) + '%' : 'N/D'}</span>
                    </div>
                </div>

                <div class="info-group">
                    <h3><i class="fas fa-chart-line"></i> Indici</h3>
					<div class="info-item">
    <span class="info-label">Istruzione Superiore:</span>
    <span class="info-value">${props['tasso di istruzione superiore'] ? parseFloat(props['tasso di istruzione superiore']).toFixed(2) + '%' : 'N/D'}</span>
</div>
<div class="info-item">
    <span class="info-label">Basso Tasso Istruzione:</span>
    <span class="info-value">${props.basso_tasso_di_istruzione ? parseFloat(props.basso_tasso_di_istruzione).toFixed(2) + '%' : 'N/D'}</span>
</div>
<div class="info-item">
    <span class="info-label">Integrazione Lavoro:</span>
    <span class="info-value">${props['tasso di integrazione del lavoro'] ? parseFloat(props['tasso di integrazione del lavoro']).toFixed(2) + '%' : 'N/D'}</span>
</div>
                    <div class="info-item">
                        <span class="info-label">Resilienza Economica:</span>
                        <span class="info-value">${props['resilienza_economica'] ? parseFloat(props['resilienza_economica']).toFixed(2) : 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Coesione Sociale:</span>
                        <span class="info-value">${props.indice_coesione_sociale ? parseFloat(props.indice_coesione_sociale).toFixed(2) : 'N/D'}</span>
                    </div>
                </div>

                <div class="info-group">
                    <h3><i class="fas fa-hammer"></i> Territoriali</h3>
                    <div class="info-item">
                        <span class="info-label">Numero edifici per particella:</span>
                        <span class="info-value">${props.buildings_count || 'N/D'}</span>
                    </div>
					    <div class="info-item">
        <span class="info-label">Densità Abitativa:</span>
        <span class="info-value">${props['densità abitativa'] ? parseFloat(props['densità abitativa']).toLocaleString('it-IT', {maximumFractionDigits: 2}) + ' ab/km²' : 'N/D'}</span>
    </div>
	    <div class="info-item">
        <span class="info-label">Superficie (m²):</span>
        <span class="info-value">${props['superfice mq'] ? parseFloat(props['superfice mq']).toLocaleString('it-IT', {maximumFractionDigits: 2}) + ' m²' : 'N/D'}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Quota al suolo:</span>
        <span class="info-value">${props.elevation_min ? parseFloat(props.elevation_min).toFixed(2) + ' m' : 'N/D'}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Quota al suolo Max:</span>
        <span class="info-value">${props.elevation_max ? parseFloat(props.elevation_max).toFixed(2) + ' m' : 'N/D'}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Occupazione Media Edificio:</span>
        <span class="info-value">${props['occupazione media dell\'edificio'] ? parseFloat(props['occupazione media dell\'edificio']).toFixed(2) + '%' : 'N/D'}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Dipendenza Strutturale:</span>
        <span class="info-value">${props.indice_dipendenza_strutturale ? parseFloat(props.indice_dipendenza_strutturale).toFixed(2) + '%' : 'N/D'}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Indice Robustezza:</span>
        <span class="info-value">${props['indice di robustezza'] ? parseFloat(props['indice di robustezza']).toFixed(2) : 'N/D'}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Opportunità Riqualificazione:</span>
        <span class="info-value">${props['opport_riqualificazione'] ? parseFloat(props['opport_riqualificazione']).toFixed(2) : 'N/D'}</span>
    </div>
	
	
	
    <div class="info-item">
        <span class="info-label">Potenziale Immobiliare:</span>
        <span class="info-value">${props['potenziale_immobiliare'] ? parseFloat(props['potenziale_immobiliare']).toFixed(2) : 'N/D'}</span>
    </div>
                    <div class="info-item">
                        <span class="info-label">CAP:</span>
                        <span class="info-value">${props.postal_code || 'N/D'}</span>
                    </div>
					 <div class="info-item">
                        <span class="info-label">Copertura del suolo:</span>
                        <span class="info-value">${landCoverLabels[props['copertura del suolo']] || props['copertura del suolo'] || 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Rischio alluvione:</span>
                        <span class="info-value">${floodRiskLabels[props['rischio_alluvione']] || props['rischio_alluvione'] || 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Rischio di frana:</span>
                        <span class="info-value">${landslideRiskLabels[props['rischio di frana']] || props['rischio di frana'] || 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Rischio erosione costiera:</span>
                        <span class="info-value">${coastalErosionLabels[props['rischio di erosione costiera']] || props['rischio di erosione costiera'] || 'N/D'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Rischio sismico:</span>
                        <span class="info-value">${seismicRiskLabels[props['rischio sismico']] || props['rischio sismico'] || 'N/D'}</span>
                    </div>
                </div>
            `;
            
            panel.classList.add('visible');
        }

        function closeInfoPanel() {
            document.getElementById('info-panel').classList.remove('visible');
        }

        // Event listeners per i controlli
function switchBasemap(value) {
    const layers = [
        'carto-light-layer', 
        'satellite-layer',
        'osm-layer',
        'google-maps-layer'
    ];
    
    const targetLayer = value === 'carto-light' ? 'carto-light-layer' :
                        value === 'satellite' ? 'satellite-layer' :
                        value === 'osm' ? 'osm-layer' :
                        'google-maps-layer';
    
    layers.forEach(layerId => {
        const visibility = (layerId === targetLayer) ? 'visible' : 'none';
        map.setLayoutProperty(layerId, 'visibility', visibility);
    });
}

        function resetAllSelects(exceptId) {
            const selects = ['demographic-select', 'economic-select', 'territorial-select'];
            selects.forEach(selectId => {
                if (selectId !== exceptId) {
                    document.getElementById(selectId).value = '';
                }
            });
        }

        function activateTheme(themeKey) {
            if (themeKey === 'landuse' || themeKey === '' || !themeKey) {
                removeTheme();
            } else {
                applyTheme(themeKey);
            }
        }

        // Event listeners per dropdown
        document.getElementById('basemap-select').addEventListener('change', (e) => {
            switchBasemap(e.target.value);
        });

        document.getElementById('mandamento-filter').addEventListener('change', (e) => {
            applyMandamentoFilter(e.target.value);
        });

        document.getElementById('borders-toggle').addEventListener('change', (e) => {
            toggleBorders(e.target.checked);
        });

        // Event listeners per perimetri
        document.getElementById('palermo-perimeter').addEventListener('change', (e) => {
            togglePerimeter('palermo-perimeter', e.target.checked);
        });

        document.getElementById('centro-storico-perimeter').addEventListener('change', (e) => {
            togglePerimeter('centro-storico-perimeter', e.target.checked);
        });

        document.getElementById('upl-cs-perimeter').addEventListener('change', (e) => {
            togglePerimeter('upl-cs-perimeter', e.target.checked);
        });

        document.getElementById('demographic-select').addEventListener('change', (e) => {
            if (e.target.value) {
                resetAllSelects('demographic-select');
                activateTheme(e.target.value);
            } else {
                activateTheme('landuse');
            }
        });

        document.getElementById('economic-select').addEventListener('change', (e) => {
            if (e.target.value) {
                resetAllSelects('economic-select');
                activateTheme(e.target.value);
            } else {
                activateTheme('landuse');
            }
        });

        document.getElementById('territorial-select').addEventListener('change', (e) => {
            if (e.target.value) {
                resetAllSelects('territorial-select');
                activateTheme(e.target.value);
            } else {
                activateTheme('landuse');
            }
        });

        // Gestione responsive
        window.addEventListener('resize', () => {
            if (window.innerWidth <= 768) {
                const panel = document.getElementById('info-panel');
                if (panel.classList.contains('visible')) {
                    panel.style.width = `${window.innerWidth - 20}px`;
                }
            }
        });

        // Gestione tastiera
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeInfoPanel();
            }
        });
	
    </script>
<!-- RESET Vista predefinita -->	
<script src="script/reset.js"></script>

	   <!-- loghi  --> 
<div id="tavolab"></div>           
<div id="ods"><a href="https://opendatasicilia.it/" title="opendatasicilia.it" target="_blank"> 
<img src="https://palermohub.opendatasicilia.it/lib/images/opendatasicilia_dredits.png" alt="opendatasicilia" width="40" border="0" title="opendatasicilia.it"></a></div>    
<!-- beta version     --> 
 <div id="beta"><img src="https://palermohub.opendatasicilia.it/legend/beta.png" width="40" title="beta version" alt="beta version"></a></div>
</body>
</html>